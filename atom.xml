<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>新的开始</title>
  <icon>https://www.gravatar.com/avatar/42636a41ab0eebc521539304cbb8d80e</icon>
  <subtitle>XINGMU&#39;S BLOG</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://daihaoxin.github.io/"/>
  <updated>2019-03-17T07:55:15.069Z</updated>
  <id>https://daihaoxin.github.io/</id>
  
  <author>
    <name>xingmu</name>
    <email>daixingmu@qq.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>linux下多个git账号的配置</title>
    <link href="https://daihaoxin.github.io/post/5f8b2e94.html"/>
    <id>https://daihaoxin.github.io/post/5f8b2e94.html</id>
    <published>2019-03-17T07:25:00.000Z</published>
    <updated>2019-03-17T07:55:15.069Z</updated>
    
    <content type="html"><![CDATA[<p>周末在 deepin linux 上安装深度学习环境的时候，把系统搞挂了，找了一下备份的系统，最近的还在去年 4 月份，思前想后，最后选择了重装系统，顺便记录下笔记。下面的操作实在全新安装的系统上进行了。</p><h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><p><a href="https://git-scm.com/downloads" target="_blank" rel="noopener">git地址</a>在这里，今天用的是 deepin 所以直接使用源安装。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apt-get install git</span></span><br></pre></td></tr></table></figure><p>全局配置 name 和 email<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git config --global user.name <span class="string">"xxx"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git config --global user.email <span class="string">"eamil@qq.com"</span></span></span><br></pre></td></tr></table></figure></p><h2 id="生成公钥"><a href="#生成公钥" class="headerlink" title="生成公钥"></a>生成公钥</h2><p>创建<code>~/xingmu/.ssh</code>目录，并进入。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir .ssh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> .ssh</span></span><br></pre></td></tr></table></figure></p><p>在<code>~/xingmu/.ssh</code>目录下，用 ssh-keygen 命令生成一组新的 id_rsa_new 和 id_rsa_new.pub，我这里需要使用 github 和 gitee(码云)两个平台，所以需要执行两次命令，分别生成 id_rsa_github/id_rs_github.pub 和 id_rsa_gitee/id_rsa_gitee.pub两组。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen -t rsa -C <span class="string">"xxx@xxx.com"</span></span></span><br></pre></td></tr></table></figure><p>需要注意的是，平时都是默认生成 id_rsa 和 id_rsa.pub 。现在要在第一个提示输入出现时分别输入带有表示意义的名字，以便于识别，这里我输入的是 id_rsa_github 和 id_rsa_gitee。</p><h2 id="配置config"><a href="#配置config" class="headerlink" title="配置config"></a>配置config</h2><p>将公钥分别配置到对应的 git 平台上，然后在<code>~/xingmu/.ssh</code>目录下新建 config 文件，配置参考如下。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## github</span></span><br><span class="line"><span class="comment"># 域名地址的别名</span></span><br><span class="line"><span class="string">Host</span> <span class="string">github</span></span><br><span class="line"><span class="comment"># 这个是真实的域名地址            </span></span><br><span class="line"><span class="string">Hostname</span> <span class="string">github.com</span></span><br><span class="line"><span class="comment"># 配置使用用户名    </span></span><br><span class="line"><span class="string">User</span> <span class="string">xxx@xx.com</span></span><br><span class="line"><span class="comment"># 这里是id_rsa的目录位置                </span></span><br><span class="line"><span class="string">IdentityFile</span> <span class="string">~/.ssh/id_rsa_github</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## 码云</span></span><br><span class="line"><span class="comment"># 域名地址的别名</span></span><br><span class="line"><span class="string">Host</span> <span class="string">gitee</span></span><br><span class="line"><span class="comment"># 这个是真实的域名地址            </span></span><br><span class="line"><span class="string">Hostname</span> <span class="string">gitee.com</span></span><br><span class="line"><span class="comment"># 配置使用用户名    </span></span><br><span class="line"><span class="string">User</span> <span class="string">xxx@xx.com</span></span><br><span class="line"><span class="comment"># 这里是id_rsa的目录位置                </span></span><br><span class="line"><span class="string">IdentityFile</span> <span class="string">~/.ssh/id_rsa_gitee</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 以下第三个或者更多</span></span><br></pre></td></tr></table></figure></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh -T git@github</span></span><br><span class="line">Hi your name! You've successfully authenticated, but GitHub does not provide shell access.</span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh -T git@gitee</span></span><br><span class="line">Hi xingmu! You've successfully authenticated, but GITEE.COM does not provide shell access.</span><br></pre></td></tr></table></figure><p>如果出现如下的提示，选择 yes 继续就可以了<br><img src="/images/多账号git.png" alt=""></p><p>然后就可以愉快的玩耍了！！</p>]]></content>
    
    <summary type="html">
    
      有时候我们需要在同一台机器上使用多个git账号，为了避免冲突，我们需要配置~/.ssh/config文件...
    
    </summary>
    
      <category term="构建工具" scheme="https://daihaoxin.github.io/categories/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="deepin" scheme="https://daihaoxin.github.io/tags/deepin/"/>
    
      <category term="git" scheme="https://daihaoxin.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>idea消息框等界面中文显示成小方块</title>
    <link href="https://daihaoxin.github.io/post/3050fa27.html"/>
    <id>https://daihaoxin.github.io/post/3050fa27.html</id>
    <published>2019-03-06T10:00:00.000Z</published>
    <updated>2019-03-17T11:06:39.848Z</updated>
    
    <content type="html"><![CDATA[<p>操作系统环境是deepin linux，版本是 2018.3 ，搜索窗口、帮助窗口、消息窗口等出现乱码，idea、webstorm、pycharm 都出现这样的情况，如下图所示。<br><img src="/images/idea-中文乱码-01.png" alt=""></p><p>这个乱码跟编码格式无关，根本原因是 IDE 的界面主题使用的字体，显示中文有 bug ，所以只有设置下中文字体就可以解决了，我这里设置的 微软雅黑。<br><img src="/images/idea-中文乱码-02.png" alt=""></p><p>另外说一下就是，在 deepin linux 中如果无法找到中文字体，可以去网上下载，通过系统自带的字体安装器安装到系统，然后重启 IDE 就可以选择了。<br><img src="/images/idea-中文乱码-03.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      解决 idea 系列编辑器在消息框中，中文显示小方块的问题
    
    </summary>
    
      <category term="编辑器" scheme="https://daihaoxin.github.io/categories/%E7%BC%96%E8%BE%91%E5%99%A8/"/>
    
    
      <category term="idea" scheme="https://daihaoxin.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>[转]阮一峰-IntersectionObserver API 使用教程</title>
    <link href="https://daihaoxin.github.io/post/3d5f3b65.html"/>
    <id>https://daihaoxin.github.io/post/3d5f3b65.html</id>
    <published>2019-02-28T16:00:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://www.ruanyifeng.com/blog/2016/11/intersectionobserver_api.html" target="_blank" rel="noopener">原文地址</a><br>一直以来，检测元素的可视状态或者两个元素的相对可视状态都不是件容易事，毕竟大部分解决办法并非完全可靠，也极易拖慢整个网站的性能。然而，随着网页发展，对上述检测的需求也随之增加了。多种情况下都需要用到元素交集变化的信息，比如：</p><ul><li>当页面滚动时，懒加载图片或其他内容。</li><li>实现“可无限滚动”网站，也就是当用户滚动网页时直接加载更多内容，无需翻页。</li><li>为计算广告收益，检测其广告元素的曝光情况。</li><li>根据用户是否已滚动到相应区域来灵活开始执行任务或动画。</li></ul><p><img src="/images/intersectionObserver-01.png" alt=""></p><p>上图的绿色方块不断滚动，顶部会提示它的可见性。</p><p>传统的实现方法是，监听到scroll事件后，调用目标元素（绿色方块）的<code>getBoundingClientRect()</code>方法，得到它对应于视口左上角的坐标，再判断是否在视口之内。这种方法的缺点是，<strong>由于scroll事件密集发生，不断调用getBoundingClientRect()来计算元素相对位置，会造成频繁的回流和重绘，而且Element.getBoundingClientRect()运行在主线程上，容易造成性能问题</strong>。</p><p>目前有一个新的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API" target="_blank" rel="noopener">IntersectionObserver API</a>，可以自动”观察”元素是否可见，<code>Chrome 51+</code> 已经支持。由于可见（visible）的本质是，目标元素与视口产生一个交叉区，所以这个 API 叫做”交叉观察器”。</p><p>Intersection Observer API 会注册一个回调方法，每当期望被监视的元素进入或者退出另外一个元素的时候(或者浏览器的视口)该回调方法将会被执行，或者两个元素的交集部分大小发生变化的时候回调方法也会被执行。通过这种方式，网站将不需要为了监听两个元素的交集变化而在主线程里面做任何操作，并且浏览器可以帮助我们优化和管理两个元素的交集变化。</p><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> io = <span class="keyword">new</span> IntersectionObserver(callback, option);</span><br></pre></td></tr></table></figure><p>上面代码中，IntersectionObserver 是浏览器原生提供的构造函数，接受两个参数，callback 是可见性变化时的回调函数，option 是配置对象（该参数可选）。</p><p>构造函数的返回值是一个观察器实例。实例的 observe 方法可以指定观察哪个 DOM 节点。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开始观察</span></span><br><span class="line">io.observe(<span class="built_in">document</span>.getElementById(<span class="string">'example'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 停止观察</span></span><br><span class="line">io.unobserve(element);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭观察器</span></span><br><span class="line">io.disconnect();</span><br></pre></td></tr></table></figure><p>上面代码中，observe 的参数是一个 DOM 节点对象。如果要观察多个节点，就要多次调用这个方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">io.observe(elementA);</span><br><span class="line">io.observe(elementB);</span><br></pre></td></tr></table></figure><h2 id="callback-参数"><a href="#callback-参数" class="headerlink" title="callback 参数"></a>callback 参数</h2><p>目标元素的可见性变化时，就会调用观察器的回调函数 callback。</p><p>callback 一般会触发两次。一次是目标元素刚刚进入视口（开始可见），另一次是完全离开视口（开始不可见）。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> io = <span class="keyword">new</span> IntersectionObserver(</span><br><span class="line">  entries =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(entries);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>上面代码中，回调函数采用的是箭头函数的写法。callback函数的参数（entries）是一个数组，每个成员都是一个<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserverEntry" target="_blank" rel="noopener">IntersectionObserverEntry</a>对象。举例来说，如果同时有两个被观察的对象的可见性发生变化，entries 数组就会有两个成员。</p><h2 id="IntersectionObserverEntry-对象"><a href="#IntersectionObserverEntry-对象" class="headerlink" title="IntersectionObserverEntry 对象"></a>IntersectionObserverEntry 对象</h2><p><code>IntersectionObserverEntry</code>对象提供目标元素的信息，一共有六个属性。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    time: 3893.92,</span><br><span class="line">    rootBounds: ClientRect &#123;</span><br><span class="line">        bottom: 920,</span><br><span class="line">        height: 1024,</span><br><span class="line">        left: 0,</span><br><span class="line">        right: 1024,</span><br><span class="line">        top: 0,</span><br><span class="line">        width: 920</span><br><span class="line">    &#125;,</span><br><span class="line">    boundingClientRect: ClientRect &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125;,</span><br><span class="line">    intersectionRect: ClientRect &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125;,</span><br><span class="line">    intersectionRatio: 0.54,</span><br><span class="line">    target: element</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>每个属性的含义如下。</p><ul><li>time：可见性发生变化的时间，是一个高精度时间戳，单位为毫秒</li><li>target：被观察的目标元素，是一个 DOM 节点对象</li><li>rootBounds：根元素的矩形区域的信息，getBoundingClientRect()方法的返回值，如果没有根元素（即直接相对于视口滚动），则返回null</li><li>boundingClientRect：目标元素的矩形区域的信息</li><li>intersectionRect：目标元素与视口（或根元素）的交叉区域的信息</li><li>intersectionRatio：目标元素的可见比例，即intersectionRect占boundingClientRect的比例，完全可见时为1，完全不可见时小于等于0<br><img src="/images/IntersectionObserver-02.png" alt=""></li></ul><p>上图中，灰色的水平方框代表视口，深红色的区域代表四个被观察的目标元素。它们各自的<code>intersectionRatio</code>图中都已经注明。</p><p>我写了一个 <a href="https://jsbin.com/canuze/edit?js,console,output" target="_blank" rel="noopener">Demo</a>，演示<code>IntersectionObserverEntry</code>对象。注意，这个 Demo 只能在 Chrome 51+ 运行。</p><h2 id="实例：惰性加载（lazy-load）"><a href="#实例：惰性加载（lazy-load）" class="headerlink" title="实例：惰性加载（lazy load）"></a>实例：惰性加载（lazy load）</h2><p>有时，我们希望某些静态资源（比如图片），只有用户向下滚动，它们进入视口时才加载，这样可以节省带宽，提高网页性能。这就叫做”惰性加载”。</p><p>有了 IntersectionObserver API，实现起来就很容易了。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="built_in">document</span>.querySelectorAll(selector));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> IntersectionObserver(</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">changes</span>) </span>&#123;</span><br><span class="line">    changes.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">change</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> container = change.target;</span><br><span class="line">      <span class="keyword">var</span> content = container.querySelector(<span class="string">'template'</span>).content;</span><br><span class="line">      container.appendChild(content);</span><br><span class="line">      observer.unobserve(container);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">query(<span class="string">'.lazy-loaded'</span>).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">  observer.observe(item);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>上面代码中，只有目标区域可见时，才会将模板内容插入真实 DOM，从而引发静态资源的加载。</p><h2 id="实例：无限滚动"><a href="#实例：无限滚动" class="headerlink" title="实例：无限滚动"></a>实例：无限滚动</h2><p>无限滚动（infinite scroll）的实现也很简单。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> intersectionObserver = <span class="keyword">new</span> IntersectionObserver(</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">entries</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果不可见，就返回</span></span><br><span class="line">    <span class="keyword">if</span> (entries[<span class="number">0</span>].intersectionRatio &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    loadItems(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Loaded new items'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始观察</span></span><br><span class="line">intersectionObserver.observe(</span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'.scrollerFooter'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>无限滚动时，最好在页面底部有一个页尾栏（又称sentinels）。一旦页尾栏可见，就表示用户到达了页面底部，从而加载新的条目放在页尾栏前面。这样做的好处是，不需要再一次调用observe()方法，现有的IntersectionObserver可以保持使用。</p><h2 id="Option-对象"><a href="#Option-对象" class="headerlink" title="Option 对象"></a>Option 对象</h2><p><code>IntersectionObserver</code> 构造函数的第二个参数是一个配置对象。它可以设置以下属性。</p><h3 id="threshold-属性"><a href="#threshold-属性" class="headerlink" title="threshold 属性"></a>threshold 属性</h3><p>threshold属性决定了什么时候触发回调函数。它是一个数组，每个成员都是一个门槛值，默认为[0]，即交叉比例（intersectionRatio）达到0时触发回调函数。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> IntersectionObserver(</span><br><span class="line">    entries =&gt; &#123;</span><br><span class="line">        <span class="comment">/* ... */</span> </span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        threshold: [<span class="number">0</span>, <span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">0.75</span>, <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>用户可以自定义这个数组。比如，<code>[0, 0.25, 0.5, 0.75, 1]</code>就表示当目标元素 0%、25%、50%、75%、100% 可见时，会触发回调函数。<br><img src="/images/IntersectionObserver-03.png" alt=""></p><h3 id="root-属性，rootMargin-属性"><a href="#root-属性，rootMargin-属性" class="headerlink" title="root 属性，rootMargin 属性"></a>root 属性，rootMargin 属性</h3><p>很多时候，目标元素不仅会随着窗口滚动，还会在容器里面滚动（比如在<code>iframe</code>窗口里滚动）。容器内滚动也会影响目标元素的可见性，参见本文开始时的那张示意图。</p><p>IntersectionObserver API 支持容器内滚动。<code>root</code>属性指定目标元素所在的容器节点（即根元素）。注意，容器元素必须是目标元素的祖先节点。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> opts = &#123;</span><br><span class="line">    root: <span class="built_in">document</span>.querySelector(<span class="string">'.container'</span>),</span><br><span class="line">    rootMargin: <span class="string">"500px 0px"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> IntersectionObserver(</span><br><span class="line">    callback,</span><br><span class="line">    opts</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>上面代码中，除了 root 属性，还有<code>rootMargin</code>属性。后者定义根元素的 margin，用来扩展或缩小 rootBounds 这个矩形的大小，从而影响 intersectionRect 交叉区域的大小。它使用CSS的定义方法，比如<code>10px 20px 30px 40px</code>，表示 top、right、bottom 和 left 四个方向的值。</p><p>这样设置以后，不管是窗口滚动或者容器内滚动，只要目标元素可见性变化，都会触发观察器。</p><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>IntersectionObserver API 是异步的，不随着目标元素的滚动同步触发。</p><p>规格写明，<code>IntersectionObserver</code>的实现，应该采用<code>requestIdleCallback()</code>，即只有线程空闲下来，才会执行观察器。这意味着，这个观察器的优先级非常低，只在其他任务执行完，浏览器有了空闲才会执行。</p><h2 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h2><ul><li>Chrome 51+（发布于 2016-05-25）</li><li>Android 5+ （Chrome 56 发布于 2017-02-06）</li><li>Edge 15 （2017-04-11）</li><li>iOS 不支持</li></ul><p>WICG 提供了一个 <a href="https://github.com/w3c/IntersectionObserver" target="_blank" rel="noopener">Polyfill</a>。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://lz5z.com/%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%87%A0%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/" target="_blank" rel="noopener">图片懒加载的几种实现方式</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API#Browser_compatibility" target="_blank" rel="noopener">MDN</a></p>]]></content>
    
    <summary type="html">
    
      IntersectionObserver API，可以自动&quot;观察&quot;元素是否可见，Chrome 51+ 已经支持。由于可见（visible）的本质是，目标元素与视口产生一个交叉区，所以这个 API 叫做&quot;交叉观察器&quot;。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="dom" scheme="https://daihaoxin.github.io/tags/dom/"/>
    
      <category term="转载" scheme="https://daihaoxin.github.io/tags/%E8%BD%AC%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>动手实现react-redux之五Provider终篇</title>
    <link href="https://daihaoxin.github.io/post/83f2f127.html"/>
    <id>https://daihaoxin.github.io/post/83f2f127.html</id>
    <published>2019-02-18T12:59:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>现在代码中依赖 context 只有 Index 组件了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> childContextTypes = &#123;</span><br><span class="line">        store: PropTypes.object</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    getChildContext() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; store &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;Header /&gt;</span><br><span class="line">                &lt;Content /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p><p>这里使用 context 的主要是为了将 store 放入 context 里面，方便子组件 connect 的时候可以拿得到 store。我们可以将这块的内容抽出来单独做个组件，并将需要使用 store 的组件作为这个组件的子组件。</p><p>这个组件命名为 Provider （提供者）。新增一个 src/Provider.js，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> childContextTypes = &#123;</span><br><span class="line">        store: PropTypes.object.isRequired</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        store: PropTypes.object</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    getChildContext() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            store: <span class="keyword">this</span>.props.store</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;React.Fragment&gt;</span><br><span class="line">                &#123;<span class="keyword">this</span>.props.children&#125;</span><br><span class="line">            &lt;<span class="regexp">/React.Fragment&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Provider;</span></span><br></pre></td></tr></table></figure></p><p>Provider 做的事情也很简单，它就是一个容器组件，会把嵌套的内容原封不动作为自己的子组件渲染出来。它还会把外界传给它的 props.store 放到 context，这样子组件 connect 的时候都可以获取到。</p><p>然后重构 src/index.js:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">"./Header"</span>;</span><br><span class="line"><span class="keyword">import</span> Content <span class="keyword">from</span> <span class="string">"./Content"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"><span class="keyword">import</span> Provider <span class="keyword">from</span> <span class="string">"./Provider"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> events = [];</span><br><span class="line">    <span class="keyword">let</span> state = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> store = &#123;</span><br><span class="line">        subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> events.push(event),</span><br><span class="line">        dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">            state = reducer(state, action);</span><br><span class="line">            events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span><br><span class="line">        &#125;,</span><br><span class="line">        getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 初始化state</span></span><br><span class="line">    store.dispatch(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">themeReducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!state) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            themeColor: <span class="string">"red"</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"CHANGE_THEME_COLOR"</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123; ...state, <span class="attr">themeColor</span>: action.themeColor &#125;;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(themeReducer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">        &lt;Header /&gt;</span><br><span class="line">        &lt;Content /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">    document.getElementById("root")</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure></p><p>这样我们就把所有关于 context 的代码从组件里面删除了。</p><p>现在通过这种方式大家不仅仅知道了 React-redux 的基础概念和用法，而且还知道这些概念到底是解决什么问题，为什么 React-redux 这么奇怪，为什么要 connect，为什么要 mapStateToProps 和 mapDispatchToProps，什么是 Provider，我们通过解决一个个问题就知道它们到底为什么要这么设计的了。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      通过解决实际遇到问题来了解 react-redux 的用法和设计原理。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>动手实现react-redux之四mapDispatchToProps</title>
    <link href="https://daihaoxin.github.io/post/a24de6ae.html"/>
    <id>https://daihaoxin.github.io/post/a24de6ae.html</id>
    <published>2019-02-18T12:57:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>重构 ThemeSwitch 组件除了需要 store 里面的数据，还需要通过 store 的 dispatch 来修改数据。现在 connect 还提供不了这个功能，需要进一步改进 connect。</p><p>仿照给 connect 传入 mapStateToProps 函数来达到获取指定数据的效果，给 connect 再提供一个 mapDispatchToProps 函数来告诉 connect 组件需要如何调用 dispatch。这个函数应该是这样的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        onSwitchColor: <span class="function">(<span class="params">color</span>) =&gt;</span> &#123;</span><br><span class="line">            dispatch(&#123; <span class="attr">type</span>: <span class="string">"CHANGE_THEME_COLOR"</span>, <span class="attr">themeColor</span>: color &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>mapDispatchToProps 也是返回一个对象，和 mapStateToProps 不同的地方是传入的参数不是 state ，而是 dispatch。下面来修改 connect ，让他可以处理 mapDispatchToProps。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">            <span class="keyword">static</span> contextTypes = &#123;</span><br><span class="line">                store: PropTypes.object</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            state = &#123;</span><br><span class="line">                allProps: &#123;&#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            componentWillMount() &#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">                <span class="comment">// 挂载的时候，进行第一次渲染</span></span><br><span class="line">                <span class="keyword">this</span>.updateProps();</span><br><span class="line">                <span class="comment">// 然后订阅 store 的后续变化，并更新</span></span><br><span class="line">                store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.updateProps());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            updateProps() &#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">                <span class="keyword">const</span> state = store.getState();</span><br><span class="line">                <span class="comment">// 额外传入 props，让获取数据更加灵活方便</span></span><br><span class="line">                <span class="keyword">let</span> stateProps = mapStateToProps ? mapStateToProps(state, <span class="keyword">this</span>.props) : &#123;&#125;;</span><br><span class="line">                <span class="keyword">let</span> dispatchProps = mapDispatchToProps ? mapDispatchToProps(store.dispatch, <span class="keyword">this</span>.props) : &#123;&#125;;</span><br><span class="line">                <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                    <span class="comment">// 整合普通的 props 和从 state 生成的 props</span></span><br><span class="line">                    allProps: &#123;</span><br><span class="line">                        ...this.props,</span><br><span class="line">                        ...stateProps,</span><br><span class="line">                        ...dispatchProps</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            render() &#123;</span><br><span class="line">                <span class="comment">// let &#123;  &#125; = this.props;</span></span><br><span class="line">                <span class="keyword">return</span> (</span><br><span class="line">                    &lt;WrappedComponent &#123;...this.state.allProps&#125; /&gt;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Connect;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect;</span><br></pre></td></tr></table></figure><p>这时候我们就可以重构 ThemeSwitch，让它摆脱 store.dispatch 和 context。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> connect <span class="keyword">from</span> <span class="string">"./connect"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThemeSwitch</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        color: PropTypes.string,</span><br><span class="line">        switchColor: PropTypes.func.isRequired</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新store中的颜色</span></span><br><span class="line">    handleSwitchColor(color) &#123;</span><br><span class="line">        <span class="keyword">this</span>.props.switchColor(color);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;button</span><br><span class="line">                    style=&#123;&#123; <span class="attr">color</span>: <span class="keyword">this</span>.props.themeColor &#125;&#125;</span><br><span class="line">                    onClick=&#123;<span class="keyword">this</span>.handleSwitchColor.bind(<span class="keyword">this</span>, <span class="string">"red"</span>)&#125;</span><br><span class="line">                &gt;</span><br><span class="line">                    设置主题颜色red</span><br><span class="line">                &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">                &lt;button</span></span><br><span class="line"><span class="regexp">                    style=&#123;&#123; color: this.props.themeColor &#125;&#125;</span></span><br><span class="line"><span class="regexp">                    onClick=&#123;this.handleSwitchColor.bind(this, "green")&#125;</span></span><br><span class="line"><span class="regexp">                &gt;</span></span><br><span class="line"><span class="regexp">                    设置主题颜色green</span></span><br><span class="line"><span class="regexp">                &lt;/</span>button&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function mapStateToProps(state, props) &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">        themeColor: state.themeColor</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function mapDispatchToProps(dispatch, props) &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">        switchColor: (color) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">            dispatch(&#123; type: "CHANGE_THEME_COLOR", themeColor: color &#125;);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps, mapDispatchToProps)(ThemeSwitch);</span></span><br></pre></td></tr></table></figure><p>这时候这三个组件的重构都已经完成了，代码大大减少、不依赖 context，并且功能和原来一样。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      通过解决实际遇到问题来了解 react-redux 的用法和设计原理。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>动手实现react-redux之三connect 和 mapStateToProps</title>
    <link href="https://daihaoxin.github.io/post/e08ec58f.html"/>
    <id>https://daihaoxin.github.io/post/e08ec58f.html</id>
    <published>2019-02-18T12:55:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>仔细看上一节完成的组件会发现两个问题：</p><ol><li>每个组件中都有大量重复获取 context ，添加 store 监听的逻辑</li><li>每个组件都依赖于 context ，使组件基本丧失了可复用性。</li></ol><p>对于第一个大量重复逻辑的问题，可以通过高阶组件抽取重复的逻辑来解决。高阶组件就是一个函数，传给它一个组件，它返回一个新的组件，它的作用就是用于代码复用，可以把组件之间可复用的代码、逻辑抽离到高阶组件当中。新的组件和传入的组件通过 props 传递信息</p><p>对于第二个问题，首先需要知道可复用组件需要具有什么样的特征，在 React 中，如果一个组件的渲染只依赖于外界传进去的 props 和自己的 state，而并不依赖于其他的任何外界数据，也就是说像纯函数一样，给它什么，它就吐出（渲染）什么出来。这种组件的复用性是最强的，别人使用的时候根本不用担心任何事情，只要看看 PropTypes 它能接受什么参数，然后把参数传进去控制它就行了。</p><p>有了思路，下面就来修改代码，首先需要一个高阶组件来协助从 context 中获取数据，然后用一个傻瓜组件来帮助提交组件的复用性。</p><p>将这个高阶组件命名为 connect，他的作用是将 context 和 可复用组件连接起来。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect = <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> contextTypes = &#123;</span><br><span class="line">            store: PropTypes.object</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 如何从 store 取数据？</span></span><br><span class="line">        </span><br><span class="line">        render() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">        &#125;</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">    return Connect;</span></span><br><span class="line"><span class="xml">&#125;;</span></span><br></pre></td></tr></table></figure><p>connect 函数接受一个组件 WrappedComponent 作为参数，把这个组件包含在一个新的组件 Connect 里面，Connect 会去 context 里面取出 store。现在要把 store 里面的数据取出来通过 props 传给 WrappedComponent。</p><p>但是每个传进去的组件需要 store 里面的数据都不一样的，所以除了给高阶组件传入 Dumb 组件以外，还需要告诉高级组件我们需要什么数据，高阶组件才能正确地去取数据。为了解决这个问题，我们可以给高阶组件传入类似下面这样的函数：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state,props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        themeColor: state.themeColor,</span><br><span class="line">        themeName: state.themeName,</span><br><span class="line">        fullName: <span class="string">`<span class="subst">$&#123;state.firstName&#125;</span> <span class="subst">$&#123;state.lastName&#125;</span>`</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>这个函数会接受 store.getState() 的结果和给 WrappedComponent 传递的 props 作为参数，然后返回一个对象。mapStateTopProps 相当于告知了 Connect 应该如何去 store 里面取数据，然后可以把这个函数的返回结果传给被包装的组件。</p><p>connect 现在是接受一个参数 mapStateToProps，然后返回一个函数，这个返回的函数才是高阶组件。它会接受一个组件作为参数，然后用 Connect 把组件包装以后再返回。 connect 的用法是：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        themeColor: state.themeColor</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">Header = connect(mapStateToProps)(Header);</span><br></pre></td></tr></table></figure></p><p>现在根据上面的描述，给 connect 加上 mapStateToProps 和 数据变化的监听，connect 完整的代码应该是：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">            <span class="keyword">static</span> contextTypes = &#123;</span><br><span class="line">                store: PropTypes.object</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            state = &#123;</span><br><span class="line">                allProps: &#123;&#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            componentWillMount() &#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">                <span class="comment">// 挂载的时候，进行第一次渲染</span></span><br><span class="line">                <span class="keyword">this</span>.updateProps();</span><br><span class="line">                <span class="comment">// 然后订阅 store 的后续变化，并更新</span></span><br><span class="line">                store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.updateProps());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            updateProps() &#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">                <span class="keyword">const</span> state = store.getState();</span><br><span class="line">                <span class="comment">// 额外传入 props，让获取数据更加灵活方便</span></span><br><span class="line">                <span class="keyword">let</span> stateProps = mapStateToProps(state, <span class="keyword">this</span>.props);</span><br><span class="line">                <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                    <span class="comment">// 整合普通的 props 和从 state 生成的 props</span></span><br><span class="line">                    allProps: &#123;</span><br><span class="line">                        ...this.props,</span><br><span class="line">                        ...stateProps</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            render() &#123;</span><br><span class="line">                <span class="comment">// let &#123;  &#125; = this.props;</span></span><br><span class="line">                <span class="keyword">return</span> (</span><br><span class="line">                    &lt;WrappedComponent &#123;...this.state.allProps&#125; /&gt;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Connect;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect;</span><br></pre></td></tr></table></figure><p>组件 Connect 的 state.allProps，它是一个对象，用来保存需要传给被包装组件的所有的参数。生命周期 componentWillMount 会调用调用 updateProps 进行初始化，然后通过 store.subscribe 监听数据变化重新调用 updateProps。</p><p>为了让 connect 返回新组件和被包装的组件使用参数保持一致，我们会把所有传给 Connect 的 props 原封不动地传给 WrappedComponent。所以在 updateProps 里面会把 stateProps 和 this.props 合并到 this.state.allProps 里面，再通过 render 方法把所有参数都传给 WrappedComponent。</p><p>现在使用 connect 修改 Header.js、Content.js。</p><p>src/Header.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> connect <span class="keyword">from</span> <span class="string">"./connect"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Header</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        color: PropTypes.string</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;h1 style=&#123;&#123; <span class="attr">color</span>: <span class="keyword">this</span>.props.themeColor &#125;&#125;&gt;React-Redux是什么&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function mapStateToProps(state, props) &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">        themeColor: state.themeColor</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps)(Header);</span></span><br></pre></td></tr></table></figure></p><p>src/Content.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> connect <span class="keyword">from</span> <span class="string">"./connect"</span>;</span><br><span class="line"><span class="keyword">import</span> ThemeSwitch <span class="keyword">from</span> <span class="string">"./ThemeSwitch"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Content</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        themeColor: PropTypes.string</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div style=&#123;&#123; <span class="attr">color</span>: <span class="keyword">this</span>.props.themeColor &#125;&#125;&gt;</span><br><span class="line">                &lt;p&gt;React-Redux是Redux的官方React绑定库。它能够使你的React组件从Redux store中读取数据，并且向store分发actions以更新数据&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">                &lt;ThemeSwitch /</span>&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function mapStateToProps(state) &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">        themeColor: state.themeColor</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps)(Content);</span></span><br></pre></td></tr></table></figure></p><p>现在通过 connect 抽取了使用 context 产生的重复逻辑，并提高了 Header 和 Context 组件的复用性，后面继续重构 ThemeSwitch 组件。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      通过解决实际遇到问题来了解 react-redux 的用法和设计原理。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>动手实现react-redux之二组合context和store</title>
    <link href="https://daihaoxin.github.io/post/ff5d605f.html"/>
    <id>https://daihaoxin.github.io/post/ff5d605f.html</id>
    <published>2019-02-18T12:50:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>在 src/index.js 中添加模拟 redux 时创建的 createStore 函数，并创建一个 themeReducer 用来初始化 state 并维护 state 的更新，通过 themeReducer 生成一个 store。然后将 store 放到 Index 组件的 context 里面，这个每个子组件都可以获取到 store 了。</p><p>修改 src/index.js:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">"./Header"</span>;</span><br><span class="line"><span class="keyword">import</span> Content <span class="keyword">from</span> <span class="string">"./Content"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> events = [];</span><br><span class="line">    <span class="keyword">let</span> state = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> store = &#123;</span><br><span class="line">        subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> events.push(event),</span><br><span class="line">        dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">            state = reducer(state, action);</span><br><span class="line">            events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span><br><span class="line">        &#125;,</span><br><span class="line">        getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 初始化state</span></span><br><span class="line">    store.dispatch(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">themeReducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!state) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            themeColor: <span class="string">"red"</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"CHANGE_THEME_COLOR"</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123; ...state, <span class="attr">themeColor</span>: action.themeColor &#125;;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(themeReducer);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> childContextTypes = &#123;</span><br><span class="line">        store: PropTypes.object</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    getChildContext() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            store</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;Header /&gt;</span><br><span class="line">                &lt;Content /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(</span></span><br><span class="line"><span class="regexp">    &lt;Index /</span>&gt;,</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>然后修改 src/Header.js 和 src/Context.js，让它从 Index 的 context 里面获取 store，并且获取里面的 themeColor 状态来设置自己的颜色。</p><p>src/Header.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Header</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> contextTypes = &#123;</span><br><span class="line">        store: PropTypes.object</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    state = &#123;</span><br><span class="line">        themeColor: <span class="string">""</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    componentWillMount() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">        <span class="comment">// 挂载的时候，进行第一次渲染</span></span><br><span class="line">        <span class="keyword">this</span>.updateThemeColor();</span><br><span class="line">        <span class="comment">// 然后订阅 store 的后续变化，并更新</span></span><br><span class="line">        store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.updateThemeColor());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateThemeColor() &#123;</span><br><span class="line">        <span class="keyword">let</span> state = <span class="keyword">this</span>.context.store.getState();</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            themeColor: state.themeColor</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// static getDerivedStateFromProps(nextProps, prevState) &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;h1 style=&#123;&#123; <span class="attr">color</span>: <span class="keyword">this</span>.state.themeColor &#125;&#125;&gt;React-Redux是什么&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Header;</span></span><br></pre></td></tr></table></figure></p><p>src/Context.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> ThemeSwitch <span class="keyword">from</span> <span class="string">"./ThemeSwitch"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Content</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> contextTypes = &#123;</span><br><span class="line">        store: PropTypes.object</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    componentWillMount() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">        <span class="comment">// 挂载的时候，进行第一次渲染</span></span><br><span class="line">        <span class="keyword">this</span>.updateThemeColor();</span><br><span class="line">        <span class="comment">// 然后订阅 store 的后续变化，并更新</span></span><br><span class="line">        store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.updateThemeColor());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateThemeColor() &#123;</span><br><span class="line">        <span class="keyword">let</span> state = <span class="keyword">this</span>.context.store.getState();</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            themeColor: state.themeColor</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div style=&#123;&#123; <span class="attr">color</span>: <span class="keyword">this</span>.state.themeColor &#125;&#125;&gt;</span><br><span class="line">                &lt;p&gt;React-Redux是Redux的官方React绑定库。它能够使你的React组件从Redux store中读取数据，并且向store分发actions以更新数据&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">                &lt;ThemeSwitch /</span>&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Content;</span></span><br></pre></td></tr></table></figure><p>修改 src/ThemeSwitch.js，添加颜色更新及两个按钮的点击事件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThemeSwitch</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> contextTypes = &#123;</span><br><span class="line">        store: PropTypes.object</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    state = &#123;</span><br><span class="line">        themeColor: <span class="string">""</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    componentWillMount() &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">        <span class="keyword">this</span>.updateThemeColor();</span><br><span class="line">        store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.updateThemeColor();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateThemeColor() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">        <span class="keyword">const</span> state = store.getState();</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">themeColor</span>: state.themeColor &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新store中的颜色</span></span><br><span class="line">    handleSwitchColor(color) &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; store &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">        store.dispatch(&#123;</span><br><span class="line">            type: <span class="string">"CHANGE_THEME_COLOR"</span>,</span><br><span class="line">            themeColor: color</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;button</span><br><span class="line">                    style=&#123;&#123; <span class="attr">color</span>: <span class="keyword">this</span>.state.themeColor &#125;&#125;</span><br><span class="line">                    onClick=&#123;<span class="keyword">this</span>.handleSwitchColor.bind(<span class="keyword">this</span>, <span class="string">"red"</span>)&#125;</span><br><span class="line">                &gt;</span><br><span class="line">                    设置主题颜色red</span><br><span class="line">                &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">                &lt;button</span></span><br><span class="line"><span class="regexp">                    style=&#123;&#123; color: this.state.themeColor &#125;&#125;</span></span><br><span class="line"><span class="regexp">                    onClick=&#123;this.handleSwitchColor.bind(this, "green")&#125;</span></span><br><span class="line"><span class="regexp">                &gt;</span></span><br><span class="line"><span class="regexp">                    设置主题颜色green</span></span><br><span class="line"><span class="regexp">                &lt;/</span>button&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default ThemeSwitch;</span></span><br></pre></td></tr></table></figure></p><p>到此 store 和 context 已经结合起来，看起来功能完成的不错，就是代码稍微啰嗦，后面继续优化。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      通过解决实际遇到问题来了解 react-redux 的用法和设计原理。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>动手实现react-redux之一初步</title>
    <link href="https://daihaoxin.github.io/post/e5e94e1.html"/>
    <id>https://daihaoxin.github.io/post/e5e94e1.html</id>
    <published>2019-02-18T12:45:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>通过 redux 动手实现可以看到它并不复杂，很多看起来奇怪的约定或者约束都是为了解决特定问题而存在的，把这些问题想清楚之后就不难理解那些奇怪的约定了，下面我们试着来实现下可以使 React 和 redux 相互结合一个库 react-redux。</p><p>在 React 中应用的状态存在可能被多个组件依赖或者影响，而 React 并没有提供很好的解决方案，我们只能把状态提升到依赖或者影响这个状态的所有组件的公共父组件上，我们把这种行为叫做状态提升。但是需求不停变化，导致状态一直在不断的提升，然后一层层的传递，这显然不是我们想要的。</p><p>后来 React 提供了 context 的概念，将共享状态放到父组件的 context 上，这个父组件下所有的子组件 都可以从 context 中直接获取状态，而不要一层层传递了。但是直接从 context 里面存放、获取数据增强了组件的耦合性；并且所有组件都可以修改 context 里面的状态就像谁都可以修改共享状态一样，导致让程序不可预测。</p><p>而 redux 中的 store 的数据不是谁都能修改，而是约定只能通过 dispatch 来进行修改，这样的话将 redux 和 context 结合起来，每个组件既可以去 context 里面获取 store 从而获取状态，又不用担心它们乱改数据了。下面我们来试一下。</p><p>使用 create-react-app 新建一个工程，然后安装 prop-types , 删除 src 下面除 <code>index.js</code>和<code>index.css</code>之外的文件，然后在 src 下面新建三个文件 Header.js、Content.js、ThemeSwitch.js。</p><p>src/Header.js：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Header</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;h1&gt;React-Redux是什么&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Header;</span></span><br></pre></td></tr></table></figure><p>src/ThemeSwitch.js：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThemeSwitch</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;button&gt;设置主题颜色red&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">                &lt;button&gt;设置主题颜色green&lt;/</span>button&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default ThemeSwitch;</span></span><br></pre></td></tr></table></figure><p>src/Content.js:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> ThemeSwitch <span class="keyword">from</span> <span class="string">"./ThemeSwitch"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Content</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;p&gt;React-Redux是Redux的官方React绑定库。它能够使你的React组件从Redux store中读取数据，并且向store分发actions以更新数据&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">                &lt;ThemeSwitch /</span>&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Content;</span></span><br></pre></td></tr></table></figure><p>修改 src/index.js:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">"./Header"</span>;</span><br><span class="line"><span class="keyword">import</span> Content <span class="keyword">from</span> <span class="string">"./Content"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;Header /&gt;</span><br><span class="line">                &lt;Content /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(</span></span><br><span class="line"><span class="regexp">    &lt;Index /</span>&gt;,</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>然后 <code>npm start</code> 启动项目，打开页面就可以看到效果。</p><p>目前只是完成项目搭建，状态和逻辑都还没添加，后面继续。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      通过解决实际遇到问题来了解 react-redux 的用法和设计原理。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>JS的宏任务和微任务</title>
    <link href="https://daihaoxin.github.io/post/54c4052.html"/>
    <id>https://daihaoxin.github.io/post/54c4052.html</id>
    <published>2019-02-16T07:07:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<h2 id="执行机制"><a href="#执行机制" class="headerlink" title="执行机制"></a>执行机制</h2><p><img src="/images/宏任务和微任务-01.png" alt=""></p><p>注意: 主线程中的代码执行也是宏任务，在主线程代码执行结束后，会先去检查也没有微任务，如果有先执行微任务，然后再去查看事件队列中还有没有需要执行的宏任务。</p><p>宏任务的优先级: 主代码块 &gt; setImmediate &gt; MessageChannel &gt; requestAnimationFrame &gt; setTimeout / setInterval<br>微任务的优先级: process.nextTick &gt; Promise &gt; MutationObserver</p><p>如果在一个微任务中递归新增微任务，是可以造成类似死循环的效果</p><h2 id="async-await函数"><a href="#async-await函数" class="headerlink" title="async/await函数"></a>async/await函数</h2><p>因为，async/await本质上还是基于Promise的一些封装，而Promise是属于微任务的一种。所以在使用await关键字与Promise.then效果类似，</p><p>async函数在await之前的代码都是同步执行的，可以理解为await之前的代码属于new Promise时传入的代码，await之后的所有代码都是在Promise.then中的回调</p><h2 id="浏览器中的表现"><a href="#浏览器中的表现" class="headerlink" title="浏览器中的表现"></a>浏览器中的表现</h2><p>在上边简单的说明了两种任务的差别，以及Event Loop的作用，那么在真实的浏览器中是什么表现呢？</p><p>假设有这样的一些DOM结构：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"renderer"</span> <span class="attr">content</span>=<span class="string">"webkit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">        <span class="selector-id">#outer</span> &#123;</span></span><br><span class="line"><span class="undefined">            padding: 20px;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#616161</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="css">        <span class="selector-id">#inner</span> &#123;</span></span><br><span class="line"><span class="undefined">            width: 100px;</span></span><br><span class="line"><span class="undefined">            height: 100px;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#757575</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"outer"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"inner"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> $inner = <span class="built_in">document</span>.querySelector(<span class="string">"#inner"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> $outer = <span class="built_in">document</span>.querySelector(<span class="string">"#outer"</span>);</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"click"</span>); <span class="comment">// 直接输出</span></span></span><br><span class="line"><span class="undefined">            </span></span><br><span class="line"><span class="javascript">            <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"promise"</span>)); <span class="comment">// 注册微任务</span></span></span><br><span class="line"><span class="undefined">            </span></span><br><span class="line"><span class="javascript">            setTimeout(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"timeout"</span>)); <span class="comment">// 注册宏任务</span></span></span><br><span class="line"><span class="undefined">            </span></span><br><span class="line"><span class="javascript">            requestAnimationFrame(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"animationFrame"</span>)); <span class="comment">// 注册宏任务</span></span></span><br><span class="line"><span class="undefined">            </span></span><br><span class="line"><span class="javascript">            $outer.setAttribute(<span class="string">"data-random"</span>, <span class="built_in">Math</span>.random()); <span class="comment">// DOM属性修改，触发微任务</span></span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 注册微任务</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">new</span> MutationObserver(<span class="function"><span class="params">_</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"observer"</span>);</span></span><br><span class="line"><span class="undefined">        &#125;).observe($outer, &#123;</span></span><br><span class="line"><span class="actionscript">            attributes: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        $inner.addEventListener(<span class="string">"click"</span>, handler);</span></span><br><span class="line"><span class="actionscript">        $outer.addEventListener(<span class="string">"click"</span>, handler);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>如果点击#inner，其执行顺序一定是：click -&gt; promise -&gt; observer -&gt; click -&gt; promise -&gt; observer -&gt; animationFrame -&gt; animationFrame -&gt; timeout -&gt; timeout。</p><p>因为 click 触发了一个宏任务 handler，按照代码中的注释，在同步的代码已经执行完以后，这时就会去查看是否有微任务可以执行，然后发现了  Promise 和 MutationObserver 两个微任务，遂执行之。</p><p>因为click事件会冒泡，所以同时也触发了 #outer 的 click 事件，再次执行了 handler 函数，这个是一个同步的过程，所以会优先执行冒泡的事件(早于其他的宏任务)，重复 #inner 的结果。</p><p>在执行完同步代码与微任务以后，这时继续向后查找有木有宏任务，然后执行了 animationFrame 和 timeout。<br>需要注意的一点是，因为我们触发了 setAttribute ，实际上修改了 DOM 的属性，这会导致页面的重绘，而这个 setAttribute  的操作是同步执行的，也就是说requestAnimationFrame的回调会早于setTimeout所执行。</p><h2 id="在Node中的表现"><a href="#在Node中的表现" class="headerlink" title="在Node中的表现"></a>在Node中的表现</h2><p>Node也是单线程，但是在处理Event Loop上与浏览器稍微有些不同，就单从API层面上来理解，Node新增了两个方法可以用来使用：微任务的process.nextTick以及宏任务的setImmediate。</p><h3 id="setImmediate与setTimeout的区别"><a href="#setImmediate与setTimeout的区别" class="headerlink" title="setImmediate与setTimeout的区别"></a>setImmediate与setTimeout的区别</h3><p>在官方文档中的定义，setImmediate 为一次 Event Loop 执行完毕后调用。setTimeout 则是通过计算一个延迟时间后进行执行。</p><p>但是同时还提到了如果在主进程中直接执行这两个操作，很难保证哪个会先触发。因为如果主进程中先注册了两个任务，然后执行的代码耗时超过setTimeout 的延迟时间，而这时定时器已经处于可执行回调的状态了。所以会先执行定时器，而执行完定时器以后才是结束了一次 Event Loop ，这时才会执行 setImmediate 。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'setTimeout'</span>))</span><br><span class="line">setImmediate(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'setImmediate'</span>))</span><br></pre></td></tr></table></figure><p>有兴趣的可以自己试验一下，执行多次真的会得到不同的结果。</p><p><img src="/images/宏任务和微任务-02.png" alt=""></p><p>但是如果后续添加一些代码以后，就可以保证setTimeout一定会在setImmediate之前触发了：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"setTimeout"</span>));</span><br><span class="line">setImmediate(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"setImmediate"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> countdown = <span class="number">1e9</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们确保这个循环的执行速度会超过定时器的倒计时，导致这轮循环没有结束时，setTimeout已经可以执行回调了，所以会先执行`setTimeout`再结束这一轮循环，也就是说开始执行`setImmediate`</span></span><br><span class="line"><span class="keyword">while</span> (countdown--) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果在另一个宏任务中，必然是setImmediate先执行：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'fs'</span>).readFile(__dirname, _ =&gt; &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'timeout'</span>))</span><br><span class="line">  setImmediate(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'immediate'</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果使用一个设置了延迟的setTimeout也可以实现相同的效果</span></span><br></pre></td></tr></table></figure></p><h3 id="process-nextTick"><a href="#process-nextTick" class="headerlink" title="process.nextTick"></a>process.nextTick</h3><p>这个可以认为是一个类似于 Promise 和 MutationObserver 的微任务实现，在代码执行的过程中可以随时插入 nextTick ，并且会保证在下一个宏任务开始之前所执行。</p><p>在使用方面的一个最常见的例子就是一些事件绑定类的操作：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Lib extends require("events").EventEmitter &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">"init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> lib = <span class="keyword">new</span> Lib();</span><br><span class="line"></span><br><span class="line">lib.on(<span class="string">"init"</span>, _ =&gt; &#123;</span><br><span class="line">    <span class="comment">// 这里将永远不会执行</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"init!"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>因为上述的代码在实例化Lib对象时是同步执行的，在实例化完成以后就立马发送了init事件。而这时在外层的主程序还没有开始执行到lib.on(‘init’)监听事件的这一步。所以会导致发送事件时没有回调，回调注册后事件不会再次发送。</p><p>我们可以很轻松的使用process.nextTick来解决这个问题：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class Lib extends require("events").EventEmitter &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        </span><br><span class="line">        process.nextTick(<span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">"init"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 同理使用其他的微任务</span></span><br><span class="line">        <span class="comment">// 比如Promise.resolve().then(_ =&gt; this.emit('init'))</span></span><br><span class="line">        <span class="comment">// 也可以实现相同的效果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这样会在主进程的代码执行完毕后，程序空闲时触发Event Loop流程查找有没有微任务，然后再发送init事件。<br>递归调用<code>process.nextTick</code>会导致报警，后续的代码永远不会被执行，这是对的，</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://mbd.baidu.com/newspage/data/landingsuper?context=%7B%22nid%22%3A%22news_9060940668586593086%22%7D&amp;n_type=1&amp;p_from=3" target="_blank" rel="noopener">https://mbd.baidu.com/newspage/data/landingsuper?context=%7B%22nid%22%3A%22news_9060940668586593086%22%7D&amp;n_type=1&amp;p_from=3</a></p><p><a href="https://www.cnblogs.com/jiasm/p/9482443.html" target="_blank" rel="noopener">https://www.cnblogs.com/jiasm/p/9482443.html</a></p>]]></content>
    
    <summary type="html">
    
      宏任务和微任务有渐渐成为面试主力的趋势
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="JS基础笔记" scheme="https://daihaoxin.github.io/tags/JS%E5%9F%BA%E7%A1%80%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>redux手动实现之五终篇</title>
    <link href="https://daihaoxin.github.io/post/d60b308f.html"/>
    <id>https://daihaoxin.github.io/post/d60b308f.html</id>
    <published>2019-02-15T07:20:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>现在已经完成了一个很通用的 createStore ，并且使用起来也很容易，性能也ok。重新审视一下我们代码，发现 stateChanger 第一个参数 state 就是 createStore 第一个参数的 state，两者其实都是全局变量 appState , 那么是否可以将 appState 和 stateChanger 合并到一起？ 这样使用 createStore 的时候就可以不用关注 state , 也避免了无意中的 <code>state.title.text=&quot;xxx&quot;</code> 这样的代码。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stateChanger</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!state)&#123;</span><br><span class="line">        state = &#123;</span><br><span class="line">            title: &#123;</span><br><span class="line">                text: <span class="string">"redux"</span>,</span><br><span class="line">                color: <span class="string">"red"</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            content: &#123;</span><br><span class="line">                text: <span class="string">"redux文档内容"</span>,</span><br><span class="line">                color: <span class="string">"blue"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>: &#123;</span><br><span class="line">            state.title.text = action.text;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>: &#123;</span><br><span class="line">            state.title.color = action.color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这时 stateChanger 就同时拥有了初始化和修改 state 的能力，如果有传入 state 就生成更新数据，否则就是初始化数据。</p><p>现在可以优化 createStore 为一个参数，将原来的参数 state 变为一个局部遍历，在完成 createStore 的操作之前，通过触发一个空操作，完成局部变量 state 的初始化。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">stateChanger</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> state = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> events = [];</span><br><span class="line">    <span class="keyword">let</span> store = &#123;</span><br><span class="line">        subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            events.push(event);</span><br><span class="line">        &#125;,</span><br><span class="line">        dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 每次修改之后， 获取新的state</span></span><br><span class="line">            state = stateChanger(state, action);</span><br><span class="line">            events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span><br><span class="line">        &#125;,</span><br><span class="line">        getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 触发一个空操作， 初始化 state</span></span><br><span class="line">    store.dispatch(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在我们就拥有了一个最终形态的 createStore ， 它接收一个可以根据 <code>action</code> 修改 state 的函数，这个函数是一个不依赖外部数据，并且没有副作用的<a href="https://www.cnblogs.com/Yang-kid/archive/2018/09/12/9637200.html" target="_blank" rel="noopener">纯函数</a>（Pure Function），现在我们把 stateChanger 改为 reducer 就完全符合 redux 的 api 了。</p><p>完整代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'title'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'content'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// const appState = &#123;</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//     title: &#123;</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//         text: "redux",</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//         color: "red",</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//     &#125;,</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//     content: &#123;</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//         text: "redux文档内容",</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//         color: "blue"</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">//     &#125;</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// &#125;;</span></span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">reducer</span><span class="params">(state, action)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (!state) &#123;</span></span><br><span class="line"><span class="undefined">                state = &#123;</span></span><br><span class="line"><span class="undefined">                    title: &#123;</span></span><br><span class="line"><span class="actionscript">                        text: <span class="string">"redux"</span>,</span></span><br><span class="line"><span class="actionscript">                        color: <span class="string">"red"</span>,</span></span><br><span class="line"><span class="undefined">                    &#125;,</span></span><br><span class="line"><span class="undefined">                    content: &#123;</span></span><br><span class="line"><span class="actionscript">                        text: <span class="string">"redux文档内容"</span>,</span></span><br><span class="line"><span class="actionscript">                        color: <span class="string">"blue"</span></span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">switch</span> (action.type) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> &#123; <span class="comment">// 构建新的对象并且返回</span></span></span><br><span class="line"><span class="undefined">                        ...state,</span></span><br><span class="line"><span class="undefined">                        title: &#123;</span></span><br><span class="line"><span class="undefined">                            ...state.title,</span></span><br><span class="line"><span class="undefined">                            text: action.text</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    &#125;;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> &#123; <span class="comment">// 构建新的对象并且返回</span></span></span><br><span class="line"><span class="undefined">                        ...state,</span></span><br><span class="line"><span class="undefined">                        title: &#123;</span></span><br><span class="line"><span class="undefined">                            ...state.title,</span></span><br><span class="line"><span class="undefined">                            color: action.color</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    &#125;;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">default</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> state; <span class="comment">// 没有修改，返回原来的对象</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 添加 createStore</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">createStore</span><span class="params">(stateChanger)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> state = <span class="literal">null</span>;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> events = [];</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> store = &#123;</span></span><br><span class="line"><span class="javascript">                subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">                    events.push(event);</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 每次修改之后， 获取新的state</span></span></span><br><span class="line"><span class="undefined">                    state = stateChanger(state, action);</span></span><br><span class="line"><span class="javascript">                    events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 触发一个空操作， 初始化 state</span></span></span><br><span class="line"><span class="undefined">            store.dispatch(&#123;&#125;);</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> store;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span><span class="params">(newTitle, oldTile = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newTitle === oldTile) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render title..."</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span></span><br><span class="line"><span class="undefined">            titleDom.innerHTML = newTitle.text;</span></span><br><span class="line"><span class="undefined">            titleDom.style.color = newTitle.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderContent</span><span class="params">(newContent, oldContent = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newContent === oldContent) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render content..."</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span></span><br><span class="line"><span class="undefined">            contentDom.innerHTML = newContent.text;</span></span><br><span class="line"><span class="undefined">            contentDom.style.color = newContent.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderApp</span><span class="params">(newAppState, oldAppState = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newAppState === oldAppState) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render app..."</span>);</span></span><br><span class="line"><span class="undefined">            renderTitle(newAppState.title, oldAppState.title);</span></span><br><span class="line"><span class="undefined">            renderContent(newAppState.content, oldAppState.content);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 生成 store</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> store = createStore(reducer);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 缓存旧的state</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> oldState = store.getState();</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 监听数据变化</span></span></span><br><span class="line"><span class="javascript">        store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取新的 state</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> newState = store.getState();</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 把新旧的 state 传进去渲染</span></span></span><br><span class="line"><span class="undefined">            renderApp(newState, oldState);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 新的 newState 变成了旧的 oldState，等待下一次数据变化重新渲染</span></span></span><br><span class="line"><span class="undefined">            oldState = newState;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">        renderApp(store.getState());</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 三秒钟之后，修改标题和标题颜色，并重新渲染</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_TEXT"</span>, text: <span class="string">"Redux是React是好基友"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_COLOR"</span>, color: <span class="string">"green"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// renderApp(store.getState());</span></span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      redux在现在前端开发中是必须要了解学习的，通过模拟思路是一种极好的学习方式
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>redux手动实现之四性能优化</title>
    <link href="https://daihaoxin.github.io/post/3d4efad1.html"/>
    <id>https://daihaoxin.github.io/post/3d4efad1.html</id>
    <published>2019-02-15T07:15:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>在上一节的代码中，其实存在一个很严重的性能问题。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span>(<span class="params">title</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"render title..."</span>);</span><br><span class="line">    <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span><br><span class="line">    titleDom.innerHTML = title.text;</span><br><span class="line">    titleDom.style.color = title.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderContent</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"render content..."</span>);</span><br><span class="line">    <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span><br><span class="line">    contentDom.innerHTML = content.text;</span><br><span class="line">    contentDom.style.color = content.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderApp</span>(<span class="params">appState</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"render app..."</span>);</span><br><span class="line">    renderTitle(appState.title);</span><br><span class="line">    renderContent(appState.content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>其他代码保持不变，依旧执行一次初始化渲染，和两次更新，然后打开控制台看下log<br><img src="/images/make-redux-401.png" alt=""></p><p>前三个是第一次渲染打印出来的。中间三个是第一次 store.dispatch 的结果，最后三个是第二次 store.dispatch 的结果。问题就是后两次的更新都没有改动 content 对象，只是修改了 title 对象。 renderContent 是不需要执行的，这里的操作需要优化。</p><p>可以通过在每个渲染函数执行渲染操作之前先做个判断，判断传入的新数据和旧的数据是不是相同，相同的话就不渲染了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span>(<span class="params">newTitle, oldTile = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newTitle === oldTile) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"render title..."</span>);</span><br><span class="line">    <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span><br><span class="line">    titleDom.innerHTML = newTitle.text;</span><br><span class="line">    titleDom.style.color = newTitle.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderContent</span>(<span class="params">newContent, oldContent = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newContent === oldContent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"render content..."</span>);</span><br><span class="line">    <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span><br><span class="line">    contentDom.innerHTML = newContent.text;</span><br><span class="line">    contentDom.style.color = newContent.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderApp</span>(<span class="params">newAppState, oldAppState = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newAppState === oldAppState) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"render app..."</span>);</span><br><span class="line">    renderTitle(newAppState.title, oldAppState.title);</span><br><span class="line">    renderContent(newAppState.content, oldAppState.content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们用一个 oldState 变量保存旧的应用状态，在需要重新渲染的时候把新旧数据传进入去：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成 store</span></span><br><span class="line"><span class="keyword">let</span> store = createStore(appState, stateChanger);</span><br><span class="line"><span class="comment">// 缓存旧的state</span></span><br><span class="line"><span class="keyword">let</span> oldState = store.getState();</span><br><span class="line"><span class="comment">// 监听数据变化</span></span><br><span class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 获取新的 state</span></span><br><span class="line">    <span class="keyword">let</span> newState = store.getState();</span><br><span class="line">    <span class="comment">// 把新旧的 state 传进去渲染</span></span><br><span class="line">    renderApp(newState, oldState);</span><br><span class="line">    <span class="comment">// 新的 newState 变成了旧的 oldState，等待下一次数据变化重新渲染</span></span><br><span class="line">    oldState = newState;</span><br><span class="line">&#125;);</span><br><span class="line">renderApp(store.getState());</span><br><span class="line"><span class="comment">// 三秒钟之后，修改标题和标题颜色，并重新渲染</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    store.dispatch(&#123; <span class="attr">type</span>: <span class="string">"UPDATE_TITLE_TEXT"</span>, <span class="attr">text</span>: <span class="string">"Redux是React是好基友"</span> &#125;);</span><br><span class="line">    store.dispatch(&#123; <span class="attr">type</span>: <span class="string">"UPDATE_TITLE_COLOR"</span>, <span class="attr">color</span>: <span class="string">"green"</span> &#125;);</span><br><span class="line">    <span class="comment">// renderApp(store.getState());</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>我们的代码现在变成了这样：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'title'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'content'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> appState = &#123;</span></span><br><span class="line"><span class="undefined">            title: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"red"</span>,</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            content: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux文档内容"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"blue"</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">stateChanger</span><span class="params">(state, action)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">switch</span> (action.type) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.text = action.text;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.color = action.color;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">default</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 添加 createStore</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">createStore</span><span class="params">(state, stateChanger)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> events = [];</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">                    events.push(event);</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">                    stateChanger(state, action);</span></span><br><span class="line"><span class="javascript">                    events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span><span class="params">(newTitle, oldTile = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newTitle === oldTile) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render title..."</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span></span><br><span class="line"><span class="undefined">            titleDom.innerHTML = newTitle.text;</span></span><br><span class="line"><span class="undefined">            titleDom.style.color = newTitle.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderContent</span><span class="params">(newContent, oldContent = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newContent === oldContent) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render content..."</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span></span><br><span class="line"><span class="undefined">            contentDom.innerHTML = newContent.text;</span></span><br><span class="line"><span class="undefined">            contentDom.style.color = newContent.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderApp</span><span class="params">(newAppState, oldAppState = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newAppState === oldAppState) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render app..."</span>);</span></span><br><span class="line"><span class="undefined">            renderTitle(newAppState.title, oldAppState.title);</span></span><br><span class="line"><span class="undefined">            renderContent(newAppState.content, oldAppState.content);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 生成 store</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> store = createStore(appState, stateChanger);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 缓存旧的state</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> oldState = store.getState();</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 监听数据变化</span></span></span><br><span class="line"><span class="javascript">        store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取新的 state</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> newState = store.getState();</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 把新旧的 state 传进去渲染</span></span></span><br><span class="line"><span class="undefined">            renderApp(newState, oldState);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 新的 newState 变成了旧的 oldState，等待下一次数据变化重新渲染</span></span></span><br><span class="line"><span class="undefined">            oldState = newState;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">        renderApp(store.getState());</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 三秒钟之后，修改标题和标题颜色，并重新渲染</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_TEXT"</span>, text: <span class="string">"Redux是React是好基友"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_COLOR"</span>, color: <span class="string">"green"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// renderApp(store.getState());</span></span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>打开页面，会发现只执行了第一次渲染，而后面的两次更新根本就不执行了，why???????</p><p>我们知道在 JavaScript 函数中，所有的参数都是值传递，参数为基本类型时传递的直接就是值，参数为对象时，参数的值就是对象所在的内存地址空间，看下我们修改 state 的地方：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stateChanger</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>: &#123;</span><br><span class="line">            state.title.text = action.text;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>: &#123;</span><br><span class="line">            state.title.color = action.color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>通过上面的代码可以看到，我们只是修改了 <code>state.title</code> 中的 text 和 color 属性，而 title 对象的内存地址依然原来的，state 的内存地址也依然是原来，所以 newState 和 oldState 都是指向同一个内存地址，所以 <code>newAppState === oldAppState</code> 为 <code>true</code>，所以也就不会触发新的渲染。</p><p><a href="https://www.jianshu.com/p/996671d4dcc4" target="_blank" rel="noopener">内存空间详细图解</a></p><p>怎么办？？？？？？</p><p>是不是可以通过浅复制生成一个新的对象，然后将修改的部分覆盖到这个新的对象上，这样既可以保证没有被修改的对象内存地址保持不变，而被修改的对象又可以获得新的地址，继而触发渲染。<br><img src="/images/make-redux-402.png" alt=""></p><p>每次修改某些数据的时候，不去改变原来的数据，而是把需要修改数据对象都 copy 一个出来，然后再去修改新生成的数据。如上图所示，content 对象就可以在不同的阶段进行共享。</p><p>根据这个思路，来修改 <code>stateChanger</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stateChanger</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123; <span class="comment">// 构建新的对象并且返回</span></span><br><span class="line">                ...state,</span><br><span class="line">                title: &#123;</span><br><span class="line">                    ...state.title,</span><br><span class="line">                    text: action.text</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123; <span class="comment">// 构建新的对象并且返回</span></span><br><span class="line">                ...state,</span><br><span class="line">                title: &#123;</span><br><span class="line">                    ...state.title,</span><br><span class="line">                    color: action.color</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state; <span class="comment">// 没有修改，返回原来的对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每次需要修改的时候都会产生新的对象，并且返回。而如果没有修改（在 default 语句中）则返回原来的 state 对象。</p><p>因为 stateChanger 不会修改原来对象了，而是返回对象，所以我们需要修改一下 createStore。让它用每次 stateChanger(state, action) 的调用结果覆盖原来的 state：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">state, stateChanger</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> events = [];</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            events.push(event);</span><br><span class="line">        &#125;,</span><br><span class="line">        dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 每次修改之后， 获取新的state</span></span><br><span class="line">            state = stateChanger(state, action);</span><br><span class="line">            events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span><br><span class="line">        &#125;,</span><br><span class="line">        getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在的完整代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'title'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'content'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> appState = &#123;</span></span><br><span class="line"><span class="undefined">            title: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"red"</span>,</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            content: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux文档内容"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"blue"</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">stateChanger</span><span class="params">(state, action)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">switch</span> (action.type) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> &#123; <span class="comment">// 构建新的对象并且返回</span></span></span><br><span class="line"><span class="undefined">                        ...state,</span></span><br><span class="line"><span class="undefined">                        title: &#123;</span></span><br><span class="line"><span class="undefined">                            ...state.title,</span></span><br><span class="line"><span class="undefined">                            text: action.text</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    &#125;;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> &#123; <span class="comment">// 构建新的对象并且返回</span></span></span><br><span class="line"><span class="undefined">                        ...state,</span></span><br><span class="line"><span class="undefined">                        title: &#123;</span></span><br><span class="line"><span class="undefined">                            ...state.title,</span></span><br><span class="line"><span class="undefined">                            color: action.color</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    &#125;;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">default</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> state; <span class="comment">// 没有修改，返回原来的对象</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 添加 createStore</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">createStore</span><span class="params">(state, stateChanger)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> events = [];</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">                    events.push(event);</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 每次修改之后， 获取新的state</span></span></span><br><span class="line"><span class="undefined">                    state = stateChanger(state, action);</span></span><br><span class="line"><span class="javascript">                    events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span><span class="params">(newTitle, oldTile = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newTitle === oldTile) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render title..."</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span></span><br><span class="line"><span class="undefined">            titleDom.innerHTML = newTitle.text;</span></span><br><span class="line"><span class="undefined">            titleDom.style.color = newTitle.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderContent</span><span class="params">(newContent, oldContent = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newContent === oldContent) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render content..."</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span></span><br><span class="line"><span class="undefined">            contentDom.innerHTML = newContent.text;</span></span><br><span class="line"><span class="undefined">            contentDom.style.color = newContent.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderApp</span><span class="params">(newAppState, oldAppState = &#123;&#125;)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (newAppState === oldAppState) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 数据没有变化就不渲染了</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"render app..."</span>);</span></span><br><span class="line"><span class="undefined">            renderTitle(newAppState.title, oldAppState.title);</span></span><br><span class="line"><span class="undefined">            renderContent(newAppState.content, oldAppState.content);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 生成 store</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> store = createStore(appState, stateChanger);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 缓存旧的state</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> oldState = store.getState();</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 监听数据变化</span></span></span><br><span class="line"><span class="javascript">        store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取新的 state</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> newState = store.getState();</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 把新旧的 state 传进去渲染</span></span></span><br><span class="line"><span class="undefined">            renderApp(newState, oldState);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 新的 newState 变成了旧的 oldState，等待下一次数据变化重新渲染</span></span></span><br><span class="line"><span class="undefined">            oldState = newState;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">        renderApp(store.getState());</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 三秒钟之后，修改标题和标题颜色，并重新渲染</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_TEXT"</span>, text: <span class="string">"Redux是React是好基友"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_COLOR"</span>, color: <span class="string">"green"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// renderApp(store.getState());</span></span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>刷新页面，然后打开控制台看下log<br><img src="/images/make-redux-403.png" alt=""></p><p>另外，并不需要担心每次修改都新建共享结构对象会有性能、内存问题，因为构建对象的成本非常低，而且我们最多保存两个对象引用（oldState 和 newState），其余旧的对象都会被垃圾回收掉。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      redux在现在前端开发中是必须要了解学习的，通过模拟思路是一种极好的学习方式
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>redux手动实现之三数据监控</title>
    <link href="https://daihaoxin.github.io/post/9995c091.html"/>
    <id>https://daihaoxin.github.io/post/9995c091.html</id>
    <published>2019-02-15T07:11:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>接着上一节继续来看代码，每次通过 dispatch 修改状态之后都要重新调用 renderApp 去渲染，不然的话页面不会改变的，那么能不能智能一点，在每次调用 dispatch 的时候自动调用 renderApp 呢？ </p><p>好像是可以的，将 renderApp 传入 dispatch ，在数据更新后，重新调用下就可以了。</p><p>但是，新的问题又来了，既然 state 是共享数据，那么使用的地方必然不止一处，如果数据更新了，需要调用的渲染函数也不止一个，dispatch 就会变得特别臃肿。</p><p>这里就要用到<a href="/post/cf3255c4.html">观察者模式</a>了，修改 createStore 为如下代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">state,stateChanger</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> events = [];</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        subscribe:<span class="function">(<span class="params">event</span>)=&gt;</span>&#123; </span><br><span class="line">             events.push(event);</span><br><span class="line">        &#125;,</span><br><span class="line">        dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">            stateChanger(state, action);</span><br><span class="line">            events.forEach(<span class="function">(<span class="params">event</span>)=&gt;</span>event());</span><br><span class="line">        &#125;,</span><br><span class="line">        getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们在 createStore 里面定义了一个数组 events和一个新的方法 subscribe，可以通过 store.subscribe(event) 的方式给 subscribe 传入一个监听函数，这个函数会被 push 到 events 中。</p><p>每次修改数据时都会调用 dispatch ，而 dispatch 除了修改数据，还会遍历调用 events 数组里面的函数，这样就可以通过 subscribe 在 events 中注册事件，来进行数据改变之后的操作。</p><p>现在只要在使用到数据的地方，通过 subscribe 注册一个事件就可以在 dispatch 触发数据改变的时候，重新渲染使用到数据的地方。</p><p>全部代码修改如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'title'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'content'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> appState = &#123;</span></span><br><span class="line"><span class="undefined">            title: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"red"</span>,</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            content: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux文档内容"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"blue"</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">stateChanger</span><span class="params">(state, action)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">switch</span> (action.type) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.text = action.text;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.color = action.color;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">default</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 添加 createStore</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">createStore</span><span class="params">(state, stateChanger)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> events = [];</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                subscribe: <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">                    events.push(event);</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">                    stateChanger(state, action);</span></span><br><span class="line"><span class="javascript">                    events.forEach(<span class="function">(<span class="params">event</span>) =&gt;</span> event());</span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span><span class="params">(title)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span></span><br><span class="line"><span class="undefined">            titleDom.innerHTML = title.text;</span></span><br><span class="line"><span class="undefined">            titleDom.style.color = title.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderContent</span><span class="params">(content)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span></span><br><span class="line"><span class="undefined">            contentDom.innerHTML = content.text;</span></span><br><span class="line"><span class="undefined">            contentDom.style.color = content.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderApp</span><span class="params">(appState)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">            renderTitle(appState.title);</span></span><br><span class="line"><span class="undefined">            renderContent(appState.content);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 生成 store</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> store = createStore(appState, stateChanger);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 监听数据变化</span></span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="javascript">        store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">            renderApp(store.getState());</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">        renderApp(store.getState());</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 三秒钟之后，修改标题和标题颜色，并重新渲染</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_TEXT"</span>, text: <span class="string">"Redux是React是好基友"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_COLOR"</span>, color: <span class="string">"green"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// renderApp(store.getState());</span></span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>现在我们有了一个比较通用的 createStore，它可以产生一种我们新定义的数据类型 store，通过 store.getState 我们获取共享状态，而且我们约定只能通过 store.dispatch 修改共享状态。store 也允许我们通过 store.subscribe 监听数据数据状态被修改了，并且进行后续的例如重新渲染页面的操作。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      redux在现在前端开发中是必须要了解学习的，通过模拟思路是一种极好的学习方式
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>redux手动实现之二store</title>
    <link href="https://daihaoxin.github.io/post/ecfe7ba3.html"/>
    <id>https://daihaoxin.github.io/post/ecfe7ba3.html</id>
    <published>2019-02-15T07:09:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>上一节通过 <code>dispatch</code> 控制了对共享数据 <code>appState</code> 操作的渠道，这种模式可以很好的解决共享数据修改难以排查的问题，现在我们再做一次抽离，使这种模式可以很好的复用到其他应用上。</p><p>构建一个函数叫<code>createStore</code>用来生成一个维护共享数据的中心<code>store</code>。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">state, stateChanger</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> stateChanger(state, action),</span><br><span class="line">        getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>createStore</code> 接收两个参数 state 和 stateChanger， state 用于表示应用程序的状态，stateChanger 就是上一节的 dispatch 用于根据 action 的变化去操作 state。</p><p>createStore 会返回包含两个方法 getState 和 dispatch 的对象。getState 用于返回 state 参数，dispatch 用于修改数据，和之前不同的是它只接受一个参数 action，然后它会把 state 和 action 一并传给 stateChanger，那么 stateChanger 就可以根据 action 来修改 state 了。</p><p>现在使用 createStore 来修改上一节的代码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'title'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'content'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> appState = &#123;</span></span><br><span class="line"><span class="undefined">            title: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"red"</span>,</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            content: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux文档内容"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"blue"</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">stateChanger</span><span class="params">(state, action)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">switch</span> (action.type) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.text = action.text;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.color = action.color;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">default</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 添加 createStore</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">createStore</span><span class="params">(state, stateChanger)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> stateChanger(state, action),</span></span><br><span class="line"><span class="javascript">                getState: <span class="function"><span class="params">()</span> =&gt;</span> state</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span><span class="params">(title)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span></span><br><span class="line"><span class="undefined">            titleDom.innerHTML = title.text;</span></span><br><span class="line"><span class="undefined">            titleDom.style.color = title.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderContent</span><span class="params">(content)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span></span><br><span class="line"><span class="undefined">            contentDom.innerHTML = content.text;</span></span><br><span class="line"><span class="undefined">            contentDom.style.color = content.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderApp</span><span class="params">(appState)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">            renderTitle(appState.title);</span></span><br><span class="line"><span class="undefined">            renderContent(appState.content);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 生成 store</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> store = createStore(appState, stateChanger);</span></span><br><span class="line"><span class="undefined">        renderApp(store.getState());</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 三秒钟之后，修改标题和标题颜色，并重新渲染</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_TEXT"</span>, text: <span class="string">"Redux是React是好基友"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            store.dispatch(&#123; type: <span class="string">"UPDATE_TITLE_COLOR"</span>, color: <span class="string">"green"</span> &#125;);</span></span><br><span class="line"><span class="undefined">            renderApp(store.getState());</span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      redux在现在前端开发中是必须要了解学习的，通过模拟思路是一种极好的学习方式
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>redux手动实现之一初步</title>
    <link href="https://daihaoxin.github.io/post/2da5028e.html"/>
    <id>https://daihaoxin.github.io/post/2da5028e.html</id>
    <published>2019-02-15T07:07:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>Redux 是一种前端新型的架构模式，经常和 React 一起使用，在我们使用 React 的时候基本都要伴随着 Redux , 并使用 react-redux 这个库把这两粘和起来。</p><p>需要注意的是，Redux 是一种从 Flux 演变而来的架构模式，它不关注跟哪个库一起用，你可以把它应用到 React 和 Vue，跟 jquery 结合也没有问题。react-redux 就是一种将 Redux 和 React 结合起来的一个库。</p><p>关于 Redux 的用法可以去官网上查看，今天主要是来看下 redux 主要解决了什么问题以及怎么解决的。</p><p>通过 webstorm 新建一个项目 redux-achieve , 新建 <code>index.html</code> 里面的 body 结构为:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'title'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'content'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>新建 <code>index.js</code>，添加代码，表示应用的状态：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> appState = &#123;</span><br><span class="line">    title: &#123;</span><br><span class="line">        text: <span class="string">"redux"</span>,</span><br><span class="line">        color: <span class="string">"red"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    content: &#123;</span><br><span class="line">        text: <span class="string">"redux文档内容"</span>,</span><br><span class="line">        color: <span class="string">"blue"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后添加以下函数，将状态渲染到页面上。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span>(<span class="params">title</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span><br><span class="line">    titleDom.innerHTML = title.text;</span><br><span class="line">    titleDom.style.color = title.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderContent</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span><br><span class="line">    contentDom.innerHTML = content.text;</span><br><span class="line">    contentDom.style.color = content.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderApp</span>(<span class="params">appState</span>) </span>&#123;</span><br><span class="line">    renderTitle(appState.title);</span><br><span class="line">    renderContent(appState.content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">renderApp(appState);</span><br></pre></td></tr></table></figure></p><p>然后打开页面，就会看到<br><img src="/images/make-redux-101.png" alt=""></p><p>这是一个很简单的页面，一看就明白，但是这个页面有个很大的问题，就是状态数据 appState 是一个全局变量，每个人都可以修改它，如果页面上有很多操作的话，出现问题的时候，很难排查哪一个操作改变了 appState 的值，这也就是常说的<strong>尽量避免使用全局变量</strong>。但是，很多时候确实需要全局变量来做到<strong>不同功能模块之间的数据共享</strong>，这是一个需要解决矛盾点。</p><p>为了解决这个问题，我们做一些约定，<strong>当我们需要修改共享数据的时候，只能通过制定的方法修改，而不能直接去改</strong>，以保证出现问题的时候，方便查找问题的根源。所以新建一个 <code>dispatch</code> 函数，专门用来修改数据。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>: &#123;</span><br><span class="line">            state.title.text = action.text;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>: &#123;</span><br><span class="line">            state.title.color = action.color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>dispatch</code> 接收两个参数，一个是要修改的共享数据对象 <code>state</code> ，一个是<code>action</code>,<code>action</code>是一个普通的js对象，<code>action</code>里面必须包含一个 type 以表示想做什么事情，dispatch 通过这个值去执行对应的操作，<code>action</code>其他的属性是可以自定义传入的。</p><p>现在所有对于数据的操作都必须通过调用 <code>dispatch</code> 函数来进行，这时排查 bug 就只需要在 dispatch 的 case 里面打上断点就可以调试出来了。dispatch 就像一个单一功能的数据接口，只需要关注 dispatch 所有对 state 数据的操作就都被监控了。</p><p>完整代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'title'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'content'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> appState = &#123;</span></span><br><span class="line"><span class="undefined">            title: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"red"</span>,</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            content: &#123;</span></span><br><span class="line"><span class="actionscript">                text: <span class="string">"redux文档内容"</span>,</span></span><br><span class="line"><span class="actionscript">                color: <span class="string">"blue"</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(state, action)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">switch</span> (action.type) &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_TEXT"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.text = action.text;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">case</span> <span class="string">"UPDATE_TITLE_COLOR"</span>: &#123;</span></span><br><span class="line"><span class="undefined">                    state.title.color = action.color;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">default</span>:</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderTitle</span><span class="params">(title)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> titleDom = <span class="built_in">document</span>.querySelector(<span class="string">"#title"</span>);</span></span><br><span class="line"><span class="undefined">            titleDom.innerHTML = title.text;</span></span><br><span class="line"><span class="undefined">            titleDom.style.color = title.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderContent</span><span class="params">(content)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> contentDom = <span class="built_in">document</span>.querySelector(<span class="string">"#content"</span>);</span></span><br><span class="line"><span class="undefined">            contentDom.innerHTML = content.text;</span></span><br><span class="line"><span class="undefined">            contentDom.style.color = content.color;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">renderApp</span><span class="params">(appState)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">            renderTitle(appState.title);</span></span><br><span class="line"><span class="undefined">            renderContent(appState.content);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="undefined">        renderApp(appState);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 三秒钟之后，修改标题和标题颜色，并重新渲染</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            dispatch(appState, &#123; type: <span class="string">"UPDATE_TITLE_TEXT"</span>, text: <span class="string">"Redux是React是好基友"</span> &#125;);</span></span><br><span class="line"><span class="actionscript">            dispatch(appState, &#123; type: <span class="string">"UPDATE_TITLE_COLOR"</span>, color: <span class="string">"green"</span> &#125;);</span></span><br><span class="line"><span class="undefined">            renderApp(appState);</span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p>]]></content>
    
    <summary type="html">
    
      redux在现在前端开发中是必须要了解学习的，通过模拟思路是一种极好的学习方式
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="动手模拟" scheme="https://daihaoxin.github.io/tags/%E5%8A%A8%E6%89%8B%E6%A8%A1%E6%8B%9F/"/>
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
      <category term="redux" scheme="https://daihaoxin.github.io/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>node爬虫之gbk网页中文乱码解决方案</title>
    <link href="https://daihaoxin.github.io/post/94238009.html"/>
    <id>https://daihaoxin.github.io/post/94238009.html</id>
    <published>2019-02-11T23:35:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>中文乱码具体是指用 <code>node</code> 请求 <code>gb2312</code> 编码的网页，无法正确获取网页中的中文（需要转码）。</p><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>直接用 <a href="https://github.com/ashtuchkin/iconv-lite" target="_blank" rel="noopener">iconv-lite</a> 模块进行转码。</p><p><a href="https://github.com/ashtuchkin/iconv-lite" target="_blank" rel="noopener">iconv-lite</a> 是一个进行编码转换的模块（<code>node</code> 默认编码 <code>utf-8</code>）。需要 <code>decode</code> 的编码必须是 <code>Buffer</code> 类型。</p><h3 id="使用http模块"><a href="#使用http模块" class="headerlink" title="使用http模块"></a>使用<code>http</code>模块</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">"querystring"</span>);</span><br><span class="line"><span class="keyword">const</span> iconv = <span class="built_in">require</span>(<span class="string">"iconv-lite"</span>);</span><br><span class="line"><span class="keyword">let</span> postData = &#123;</span><br><span class="line">    username:<span class="string">"username"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> req = http.request(&#123;</span><br><span class="line">    hostname: <span class="string">"xxxx.com"</span>,</span><br><span class="line">    port: <span class="number">80</span>,</span><br><span class="line">    path: <span class="string">"/pathname"</span>,</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, (res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> chunks = [];</span><br><span class="line">    res.on(<span class="string">"data"</span>, (chunk) =&gt; &#123;</span><br><span class="line">        chunks.push(chunk);</span><br><span class="line">    &#125;);</span><br><span class="line">    res.on(<span class="string">"end"</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> html = iconv.decode(Buffer.concat(chunks), <span class="string">"gb2312"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">req.on(<span class="string">"error"</span>, (e) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">`problem with request: <span class="subst">$&#123;e.message&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// write data to request body</span></span><br><span class="line">req.write(querystring.stringify(postData));</span><br><span class="line">req.end();</span><br></pre></td></tr></table></figure><h3 id="使用axios"><a href="#使用axios" class="headerlink" title="使用axios"></a>使用<code>axios</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> iconv = <span class="built_in">require</span>(<span class="string">"iconv-lite"</span>);</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">"axios"</span>);</span><br><span class="line">axios.get(<span class="string">`url`</span>, &#123; <span class="attr">responseType</span>: <span class="string">"arraybuffer"</span> &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> html = iconv.decode(response.data, <span class="string">"gb2312"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(html);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      最近为了帮家里领导找资料，用爬虫爬了一波，遇到了中文乱码的问题，在此记录一下。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="nodejs" scheme="https://daihaoxin.github.io/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>npx的使用</title>
    <link href="https://daihaoxin.github.io/post/7c5a0d00.html"/>
    <id>https://daihaoxin.github.io/post/7c5a0d00.html</id>
    <published>2019-02-11T23:35:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>Node 自带 npm 模块，所以可以直接使用 npx 命令。万一不能用，就要手动安装一下。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install -g npx</span></span><br></pre></td></tr></table></figure></p><h2 id="调用项目安装的模块"><a href="#调用项目安装的模块" class="headerlink" title="调用项目安装的模块"></a>调用项目安装的模块</h2><p>npx 想要解决的主要问题，就是调用项目内部安装的模块。比如，项目内部安装了测试工具 Mocha。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install -D mocha</span></span><br></pre></td></tr></table></figure></p><p>一般来说，调用 <code>Mocha</code> ，只能在项目脚本和 <code>package.json</code> 的scripts字段里面， 如果想在命令行下调用，必须像下面这样。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 项目的根目录下执行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> node-modules/.bin/mocha --version</span></span><br></pre></td></tr></table></figure></p><p><code>npx</code> 就是想解决这个问题，让项目内部安装的模块用起来更方便，只要像下面这样调用就行了。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx mocha --version</span></span><br></pre></td></tr></table></figure></p><p><code>npx</code> 的原理很简单，就是运行的时候，会到<code>node_modules/.bin</code>路径和环境变量<code>$PATH</code>里面，检查命令是否存在。<br>由于 <code>npx</code> 会检查环境变量<code>$PATH</code>，所以系统命令也可以调用。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 等同于 ls</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npx ls</span></span><br></pre></td></tr></table></figure></p><p>注意，<code>Bash</code> 内置的命令不在<code>$PATH</code>里面，所以不能用。比如，<code>cd</code>是 <code>Bash</code> 命令，因此就不能用<code>npx cd</code>。</p><h2 id="避免全局安装模块"><a href="#避免全局安装模块" class="headerlink" title="避免全局安装模块"></a>避免全局安装模块</h2><p>除了调用项目内部模块，<code>npx</code> 还能避免全局安装的模块。比如，<code>create-react-app</code>这个模块是全局安装，<code>npx</code> 可以运行它，而且不进行全局安装。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx create-react-app my-react-app</span></span><br></pre></td></tr></table></figure></p><p>上面代码运行时，<code>npx</code> 将<code>create-react-app</code>下载到一个临时目录，使用以后再删除。所以，以后再次执行上面的命令，会重新下载<code>create-react-app</code>。</p><p>下载全局模块时，<code>npx</code> 允许指定版本。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx uglify-js@3.1.0 main.js -o ./dist/main.js</span></span><br></pre></td></tr></table></figure></p><p>上面代码指定使用 <code>3.1.0</code>版本的<code>uglify-js</code>压缩脚本。</p><p>注意，只要 <code>npx</code> 后面的模块无法在本地发现，就会下载同名模块。比如，本地没有安装<code>http-server</code>模块，下面的命令会自动下载该模块，在当前目录启动一个 <code>Web</code> 服务。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx http-server</span></span><br></pre></td></tr></table></figure></p><h2 id="–no-install-参数和–ignore-existing-参数"><a href="#–no-install-参数和–ignore-existing-参数" class="headerlink" title="–no-install 参数和–ignore-existing 参数"></a>–no-install 参数和–ignore-existing 参数</h2><p>如果想让 <code>npx</code> 强制使用本地模块，不下载远程模块，可以使用<code>--no-install</code>参数。如果本地不存在该模块，就会报错。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx --no-install http-server</span></span><br></pre></td></tr></table></figure></p><p>反过来，如果忽略本地的同名模块，强制安装使用远程模块，可以使用<code>--ignore-existing</code>参数。比如，本地已经全局安装了<code>create-react-app</code>，但还是想使用远程模块，就用这个参数。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx --ignore-existing create-react-app my-react-app</span></span><br></pre></td></tr></table></figure></p><h2 id="使用不同版本的-node"><a href="#使用不同版本的-node" class="headerlink" title="使用不同版本的 node"></a>使用不同版本的 node</h2><p>利用 <code>npx</code> 可以下载模块这个特点，可以指定某个版本的 <code>Node</code> 运行脚本。它的窍门就是使用 <code>npm</code> 的 <code>node 模块</code>。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx node@0.12.8 -v</span></span><br><span class="line">v0.12.8</span><br></pre></td></tr></table></figure></p><p>上面命令会使用 <code>0.12.8</code> 版本的 <code>Node</code> 执行脚本。原理是从 <code>npm</code> 下载这个版本的 <code>node</code>，使用后再删掉。</p><p>某些场景下，这个方法用来切换 <code>Node</code> 版本，要比 <code>nvm</code> 那样的版本管理器方便一些。</p><h2 id="p-参数"><a href="#p-参数" class="headerlink" title="-p 参数"></a>-p 参数</h2><p><code>-p</code>参数用于指定 <code>npx</code> 所要安装的模块，所以上一节的命令可以写成下面这样。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx -p node@0.12.8 node -v </span></span><br><span class="line">v0.12.8</span><br></pre></td></tr></table></figure></p><p>上面命令先指定安装<a href="mailto:`node@0.12.8" target="_blank" rel="noopener">`node@0.12.8</a><code>，然后再执行</code>node -v`命令。</p><p><code>-p</code>参数对于需要安装多个模块的场景很有用。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx -p lolcatjs -p cowsay [<span class="built_in">command</span>]</span></span><br></pre></td></tr></table></figure></p><h2 id="c-参数"><a href="#c-参数" class="headerlink" title="-c 参数"></a>-c 参数</h2><p>如果 <code>npx</code> 安装多个模块，默认情况下，所执行的命令之中，只有第一个可执行项会使用 <code>npx</code> 安装的模块，后面的可执行项还是会交给 <code>Shell</code> 解释。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx -p lolcatjs -p cowsay <span class="string">'cowsay hello | lolcatjs'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 报错</span></span><br></pre></td></tr></table></figure></p><p>上面代码中，<code>cowsay hello | lolcatjs</code>执行时会报错，原因是第一项<code>cowsay</code>由 <code>npx</code> 解释，而第二项命令<code>localcatjs</code>由 <code>Shell</code> 解释，但是<code>lolcatjs</code>并没有全局安装，所以报错。</p><p><code>-c</code>参数可以将所有命令都用 <code>npx</code> 解释。有了它，下面代码就可以正常执行了。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx -p lolcatjs -p cowsay -c <span class="string">'cowsay hello | lolcatjs'</span></span></span><br></pre></td></tr></table></figure></p><p><code>-c</code>参数的另一个作用，是将环境变量带入所要执行的命令。举例来说，<code>npm</code> 提供当前项目的一些环境变量，可以用下面的命令查看。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run env | grep npm_</span></span><br></pre></td></tr></table></figure></p><p><code>-c</code>参数可以把这些 <code>npm</code> 的环境变量带入 <code>npx</code> 命令。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx -c <span class="string">'echo "$npm_package_name"'</span></span></span><br></pre></td></tr></table></figure></p><p>上面代码会输出当前项目的项目名。</p><h2 id="执行-GitHub-源码"><a href="#执行-GitHub-源码" class="headerlink" title="执行 GitHub 源码"></a>执行 GitHub 源码</h2><p><code>npx</code> 还可以执行 <code>GitHub</code> 上面的模块源码。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 执行 Gist 代码</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npx https://gist.github.com/zkat/4bc19503fe9e9309e2bfaa2c58074d32</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行仓库代码</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npx github:piuccio/cowsay hello</span></span><br></pre></td></tr></table></figure></p><p>注意，远程代码必须是一个模块，即必须包含<code>package.json</code>和入口脚本。</p>]]></content>
    
    <summary type="html">
    
      npm 从5.2版开始，增加了 npx 命令。它有很多用处，本文介绍该命令的主要使用场景。。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="nodejs" scheme="https://daihaoxin.github.io/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>[转]重绘与重排(回流)</title>
    <link href="https://daihaoxin.github.io/post/49cb51ee.html"/>
    <id>https://daihaoxin.github.io/post/49cb51ee.html</id>
    <published>2019-02-06T04:00:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>早在五年前，Google 就提出了 1s 完成终端页面的首屏渲染的标准。</p><p><img src="/images/重绘与重排.png" alt=""></p><p>常见的优化网络请求的方法有：DNS Lookup，减少重定向，避免 JS、CSS 阻塞，并行请求，代码压缩，缓存，按需加载，前端模块化…</p><p>虽然相较于网络方面的优化，前端渲染的优化显得杯水车薪，而且随着浏览器和硬件性能的增长，再加上主流前端框架（react、vue、angular）的已经帮我们解决了大多数的性能问题，但是前端渲染性能优化依然值得学习，除去网络方面的消耗，留给前端渲染的时间已经不多了。本文主要学习前端渲染相关的问题。</p><h2 id="浏览器是如何渲染一个页面的"><a href="#浏览器是如何渲染一个页面的" class="headerlink" title="浏览器是如何渲染一个页面的"></a>浏览器是如何渲染一个页面的</h2><ol><li>浏览器把获取到的 HTML 代码解析成1个 DOM 树，HTML 中的每个 tag 都是 DOM 树中的1个节点，根节点是 document 对象。DOM 树里包含了所有 HTML 标签，包括 display:none 隐藏的标签，还有用 JS 动态添加的元素等。</li><li>浏览器把所有样式解析成样式结构体，在解析的过程中会去掉浏览器不能识别的样式，比如 IE 会去掉 -moz 开头的样式。</li><li>DOM Tree 和样式结构体组合后构建 render tree, render tree 类似于 DOM tree，但区别很大，render tree 能识别样式，render tree 中每个 NODE 都有自己的 style，而且 render tree 不包含隐藏的节点 (比如 display:none 的节点，还有 head 节点)，因为这些节点不会用于呈现，而且不会影响呈现的节点，所以就不会包含到 render tree 中。注意 <code>visibility:hidden</code> 隐藏的元素还是会包含到 render tree 中的，因为 <code>visibility:hidden</code> 会影响布局(layout)，会占有空间。根据css2的标准，render tree 中的每个节点都称为 box(Box dimensions)，box所有属性：width, height, margin, padding, left, top, border等。<blockquote><p>注意结果就是渲染树是和DOM树是相对应的，但是不是一一对应的，因为非可视化的DOM元素不会插入到渲染树中，例如head元素；而如果元素的display属性的值是none的话，也不会出现在渲染树中。</p></blockquote></li><li>一旦 render tree 构建完毕后，浏览器就可以根据 render tree 来绘制页面了。</li></ol><p><img src="/images/重绘与重排-02.png" alt=""></p><p>在此过程中，前端工程师主要的敌人为：</p><ol><li>重新计算样式（Recalculate Style）、计算布局（Layout）=&gt; Rendering/Reflow。</li><li>绘制 =&gt; Painting/Repaint。</li></ol><h2 id="重绘与回流"><a href="#重绘与回流" class="headerlink" title="重绘与回流"></a>重绘与回流</h2><p>在讨论回流与重绘之前，我们要知道：</p><ol><li>浏览器使用流式布局模型 (Flow Based Layout)。</li><li>浏览器会把HTML解析成DOM，把CSS解析成CSSOM，DOM和CSSOM合并就产生了Render Tree。</li><li>有了RenderTree，我们就知道了所有节点的样式，然后计算他们在页面上的大小和位置，最后把节点绘制到页面上。</li><li>由于浏览器使用流式布局，对Render Tree的计算通常只需要遍历一次就可以完成，但table及其内部元素除外，他们可能需要多次计算，通常要花3倍于同等元素的时间，这也是为什么要避免使用table布局的原因之一。</li></ol><ol><li>回流（Reflow）是指布局引擎为frame计算图形的过程, frame是一个矩形，拥有宽高和相对父容器的偏移。frame用来显示盒模型（content model）， 但一个content model可能会显示为多个frame，比如换行的文本每行都会显示为一个frame。<br> 当Render Tree中部分或全部元素的尺寸、结构、或某些属性发生改变时，浏览器重新渲染部分或全部文档的过程就是回流。页面第一次加载的时候，至少发生一次回流。</li><li>当 render tree 中的一些元素需要更新属性，而这些属性只是影响元素的外观，风格，而不会影响布局的，比如背景色、前景色等，这个过程叫做重绘（repaint）</li></ol><p>在回流的时候，浏览器会使 render tree 中受到影响的部分失效，并重新构造这部分渲染树，完成回流后，浏览器会重新绘制受影响的部分到屏幕中，该过程成为重绘。因此回流必将引起重绘，而重绘不一定会引起回流。</p><p>Reflow 的成本比 Repaint 高得多的多。回流的花销跟render tree有多少节点需要重新构建有关系，假设你直接操作body，比如在body最前面插入1个元素，会导致整个render tree回流，这样代价当然会比较高，但如果是指body后面插入1个元素，则不会影响前面元素的回流。</p><p><strong>一句话：回流必将引起重绘，重绘不一定会引起回流。</strong></p><h3 id="重绘何时发生"><a href="#重绘何时发生" class="headerlink" title="重绘何时发生"></a>重绘何时发生</h3><p>当一个元素的外观的可见性 visibility 发生改变的时候，但是不影响布局。类似的例子包括：outline, visibility, background color。</p><h3 id="回流何时发生"><a href="#回流何时发生" class="headerlink" title="回流何时发生"></a>回流何时发生</h3><ol><li>页面渲染初始化。</li><li>调整窗口大小。</li><li>改变字体，比如修改网页默认字体。</li><li>增加或者移除样式表。</li><li>内容变化，比如文本改变或者图片大小改变而引起的计算值宽度和高度改变。</li><li>激活 CSS 伪类，比如 :hover</li><li>操作 class 属性。</li><li>脚本操作 DOM，增加删除或者修改 DOM 节点，元素尺寸改变——边距、填充、边框、宽度和高度。</li><li>计算 offsetWidth 和 offsetHeight 属性。</li><li>设置 style 属性的值。</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="built_in">document</span>.body.style</span><br><span class="line">s.padding = <span class="string">"2px"</span>; <span class="comment">// 回流+重绘</span></span><br><span class="line">s.border = <span class="string">"1px solid red"</span>; <span class="comment">// 回流+重绘</span></span><br><span class="line">s.color = <span class="string">"blue"</span>; <span class="comment">// 重绘</span></span><br><span class="line">s.backgroundColor = <span class="string">"#ccc"</span>; <span class="comment">// 重绘</span></span><br><span class="line">s.fontSize = <span class="string">"14px"</span>; <span class="comment">// 再一次 回流+重绘</span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">'abc!'</span>)); <span class="comment">// 回流+重绘</span></span><br></pre></td></tr></table></figure><h2 id="聪明的浏览器"><a href="#聪明的浏览器" class="headerlink" title="聪明的浏览器"></a>聪明的浏览器</h2><p>如果向上述代码中那样，浏览器不停地回流+重绘，很可能性能开销非常大，实际上浏览器会优化这些操作，将所有引起回流和重绘的操作放入一个队列中，等待队列达到一定的数量或者时间间隔，就 flush 这个队列，一次性处理所有的回流和重绘。</p><p>虽然有浏览器优化，但是当我们向浏览器请求一些 style 信息的时候，浏览器为了确保我们能拿到精确的值，就会提前 flush 队列，有可能会引发回流。</p><ol><li>offsetTop/Left/Width/Height</li><li>scrollTop/Left/Width/Height</li><li>clientTop/Left/Width/Height</li><li>width,height</li><li>getComputedStyle(), 或者 IE的 currentStyle</li></ol><h2 id="如何减少回流、重绘"><a href="#如何减少回流、重绘" class="headerlink" title="如何减少回流、重绘"></a>如何减少回流、重绘</h2><ol><li><p>JavaScript 修改 class 的时候，就尽可能使用使用 classList 代替 className ，因为 className 只要赋值，就一定出现一次 rendering 计算；classList 的 add 和 remove，浏览器会进行样式名是否存在的判断，以减少重复的 rendering。<br>尽可能在DOM树的里面改变class，可以限制了回流的范围，使其影响尽可能少的节点。例如，你应该避免通过改变对包装元素类去影响子节点的显示。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ele.className += <span class="string">'something'</span></span><br><span class="line">ele.classList.add(<span class="string">'something'</span>)</span><br><span class="line">ele.classList.remove(<span class="string">'something'</span>)</span><br></pre></td></tr></table></figure></li><li><p>避免使用table布局。</p></li><li><p>保持 DOM 操作“原子性”</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line"><span class="comment">// 下面这个读取操作会导致连续的清空和放入操作到 重绘+回流队列</span></span><br><span class="line"><span class="keyword">var</span> newWidth = ele.offsetWidth + <span class="number">10</span>;</span><br><span class="line">ele.style.width = newWidth + <span class="string">'px'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> newHeight = ele.offsetHeight + <span class="number">10</span>;</span><br><span class="line">ele.style.height = newHeight + <span class="string">'px'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// good 读写分离，批量操作</span></span><br><span class="line"><span class="keyword">var</span> newWidth = ele.offsetWidth + <span class="number">10</span>; <span class="comment">// read</span></span><br><span class="line"><span class="keyword">var</span> newHeight = ele.offsetHeight + <span class="number">10</span>; <span class="comment">// read</span></span><br><span class="line">ele.style.width = newWidth + <span class="string">'px'</span>; <span class="comment">// write</span></span><br><span class="line">ele.style.height = newHeight + <span class="string">'px'</span>; <span class="comment">// write</span></span><br></pre></td></tr></table></figure></li><li><p>如果动态改变style，则使用cssText。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> left = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> top = <span class="number">1</span>;</span><br><span class="line">el.style.left = left + <span class="string">"px"</span>;</span><br><span class="line">el.style.right = right + <span class="string">"px"</span>;</span><br><span class="line"><span class="comment">//动态改变样式，比较好的写法</span></span><br><span class="line">el.style.cssText += <span class="string">";left:"</span> + left + <span class="string">"px; top:"</span> + top + <span class="string">"px;"</span>;</span><br></pre></td></tr></table></figure></li><li><p>不要经常访问会引起浏览器flush队列的属性，如果你确实要访问，利用缓存</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">for</span>(循环) &#123;</span><br><span class="line">     el.style.left = el.offsetLeft + <span class="number">5</span> + <span class="string">"px"</span>;</span><br><span class="line">     el.style.top = el.offsetTop + <span class="number">5</span> + <span class="string">"px"</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// 比较好的写法</span></span><br><span class="line"><span class="keyword">var</span> left = el.offsetLeft,</span><br><span class="line">top = el.offsetTop,</span><br><span class="line">s = el.style;</span><br><span class="line"><span class="keyword">for</span>(循环) &#123;</span><br><span class="line">     left += <span class="number">10</span>;</span><br><span class="line">     top += <span class="number">10</span>;</span><br><span class="line">     s.left = left + <span class="string">"px"</span>;</span><br><span class="line">     s.top = top + <span class="string">"px"</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>对具有复杂动画的元素使用绝对定位，使它脱离文档流，否则会引起父元素及后续元素频繁回流<br>动画效果应用到 position 属性为 absolute 或 fixed 的元素上，它们不影响其他元素的布局，所它他们只会导致重新绘制，而不是一个完整回流。这样消耗会更低。</p><blockquote><p>使用CSS3的transition也可以获得不错的性能。</p></blockquote></li></ol><p>假设block1是<code>position: absolute</code>的元素，block2是<code>position: relative</code>的元素。当使用jquery的<code>animate()</code>方法移动元素来展示一些动画效果时<code>$(&quot;#block1&quot;).animate({left:50});</code>block1 移动，会影响到它父元素下的所有子元素。因为在移动过程中，所有子元素需要判断 block1 的<code>z-index</code>是否在自己的上面，如果是在自己的上面，则需要重绘，这里不会引起回流。</p><p><code>$(&quot;#block2&quot;).animate({marginLeft:50});</code> , block2 是相对定位的元素，影响的元素与 block1 一样，但是因为 block2 非绝对定位，而且改变的是 marginLeft 属性，所以这里每次改变不但会重绘，还会引起父元素及其下元素的回流。</p><p>​ 所以，动画效果应用到position属性为absolute或fixed的元素上，它们不影响其他元素的布局，所它他们只会导致重新绘制，而不是一个完整回流。这样消耗会更低。</p><ol start="7"><li><p>让要操作的元素进行“离线处理”，处理完后一起更新。这里所谓的”离线处理”即让元素不存在于render tree中</p><ul><li>使用DocumentFragment进行缓存操作,引发一次回流和重绘；<ul><li>这个主要用于添加元素的时候，就是先把所有要添加到元素添加到1个div中(这个div也是新加的)，最后才把这个div append到body中。</li></ul></li><li>使用display:none技术，只引发两次回流和重绘；<ul><li>先display:none 隐藏元素，然后对该元素进行所有的操作，最后再显示该元素。因对display:none的元素进行操作不会引起回流、重绘。所以只要操作只会有2次回流。</li></ul></li><li><p>使用cloneNode(true or false) 和 replaceChild 技术，引发一次回流和重绘。</p><p>假如需要在下面的 html 中添加两个 li 节点：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> ul = <span class="built_in">document</span>.getElementByTagName(<span class="string">'ul'</span>)</span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> man = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>)</span></span><br><span class="line"><span class="actionscript">man.innerHTML = <span class="string">'man'</span></span></span><br><span class="line"><span class="undefined">ul.appendChild(li)</span></span><br><span class="line"><span class="undefined"> </span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> woman = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>)</span></span><br><span class="line"><span class="actionscript">woman.innerHTML = <span class="string">'woman'</span></span></span><br><span class="line"><span class="undefined">ul.appendChild(woman)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上述代码会发生两次回流，假如使用 <code>display: none</code> 的方案，虽然能够减少回流次数，但是会发生一次闪烁，这时候使用 <code>DocumentFragment</code> 的优势就体现出来了。</p><p>DocumentFragment 有两大特点：</p></li><li><p>DocumentFragment 节点不属于文档树，继承的 parentNode 属性总是 null。</p></li><li>当请求把一个 DocumentFragment 节点插入文档树时，插入的不是 DocumentFragment 自身，而是它的所有子孙节点。这使得 DocumentFragment 成了有用的占位符，暂时存放那些一次插入文档的节点。它还有利于实现文档的剪切、复制和粘贴操作。、<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> man = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>)</span><br><span class="line"><span class="keyword">let</span> woman = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>)</span><br><span class="line">man.innerHTML = <span class="string">'man'</span></span><br><span class="line">woman.innerHTML = <span class="string">'woman'</span></span><br><span class="line">fragment.appendChild(man)</span><br><span class="line">fragment.appendChild(woman)</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(spanNode)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>避免使用CSS表达式（例如：calc()）</p></li></ol><p>这项规则较过时，但确实是个好的主意。主要的原因，这些表现是如此昂贵，是因为他们每次重新计算文档，或部分文档、回流。正如我们从所有的很多事情看到的：引发回流，它可以每秒产生成千上万次。当心！</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://lz5z.com/Web%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E9%A1%B5%E9%9D%A2%E9%87%8D%E7%BB%98%E5%92%8C%E5%9B%9E%E6%B5%81/" target="_blank" rel="noopener">Web性能优化-页面重绘和回流</a><br><a href="http://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html" target="_blank" rel="noopener">网页性能管理详解</a><br><a href="https://www.cnblogs.com/blueSkys/p/3685740.html" target="_blank" rel="noopener">了解DocumentFragment 给我们带来的性能优化</a><br><a href="http://www.blogjava.net/BearRui/archive/2010/05/10/web_performance_repaint_relow.html" target="_blank" rel="noopener">高性能WEB开发(8) - 页面呈现、重绘、回流</a></p>]]></content>
    
    <summary type="html">
    
      了解回流和重排对与前端性能优化极具积极意义。
    
    </summary>
    
      <category term="html/css" scheme="https://daihaoxin.github.io/categories/html-css/"/>
    
    
      <category term="html/css" scheme="https://daihaoxin.github.io/tags/html-css/"/>
    
      <category term="转载" scheme="https://daihaoxin.github.io/tags/%E8%BD%AC%E8%BD%BD/"/>
    
      <category term="性能" scheme="https://daihaoxin.github.io/tags/%E6%80%A7%E8%83%BD/"/>
    
  </entry>
  
  <entry>
    <title>[转]事件循环是如何影响页面渲染的？</title>
    <link href="https://daihaoxin.github.io/post/6b1caa88.html"/>
    <id>https://daihaoxin.github.io/post/6b1caa88.html</id>
    <published>2019-01-19T16:00:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://harttle.land/2019/01/16/how-eventloop-affects-rendering.html" target="_blank" rel="noopener">原文地址</a></p><ul><li>页面渲染/交互任务也会插入在 Task Queue 中，会与各种异步机制插入的任务交错执行。</li><li>Microtask Queue 会在下一个任务开始之前清空。</li><li>单个耗时任务和 Microtask Queue 都会阻塞页面交互，Task Queue 则不影响。</li><li>渲染时机可以通过 requestAnimationFrame 精确控制。</li><li>setImmediate 与 setTimeout 一样使用 Task Queue，但克服了 4ms 限制。</li></ul><h2 id="任务与队列的概念"><a href="#任务与队列的概念" class="headerlink" title="任务与队列的概念"></a>任务与队列的概念</h2><p>JavaScript 的异步机制由 事件循环 实现，这些 API 的不同表现在进入和离开任务队列的时机。 为了讨论方便，先解释几个概念。</p><ul><li>任务与调用栈。由于单线程的特性，每个 JavaScript 执行上下文只有一个调用栈，其中保存着当前任务中所有未执行完的函数。只要调用栈非空，JavaScript 引擎就会持续地、不被打断地（从进程内的角度来看）执行完当前栈中的所有函数，因此 JavaScript 有 “run-to-completion” 的特性。调用栈被清空时意味着当前任务执行结束。</li><li>Task Queue 是事件循环的主要数据结构。当前调用栈为空时（上一个任务已经完成），事件循环机制会持续地轮询 Task Queue，只要队列中有任务就拿出来执行。在任务执行期间插入的任务会进入 Task Queue 尾部。会加入 Task 队列的包括：setTimeout, setInterval, setImmediate，postMessage，MessageChannel，UI 事件，I/O，页面渲染。</li><li>Microtask Queue 在 Task Queue 的每个任务执行结束后，下一个任务执行开始前，会执行并清空 Microtask Queue 中的所有任务。在 Microtask 执行期间插入的任务也会进入当前 Microtask Queue。会加入 MicroTask 队列的包括：Promise, MutationObserver，process.nextTick。</li></ul><blockquote><p>上述异步 API 的分类依据的是最新标准或最新实现。存在一些例外，比如：Node &lt; 9 的 process.nextTick 实现的是 Task 语义（而非 Microtask）；IE8 中的 postMessage 是同步的；Edge 浏览器在点击事件处理函数之间不会清空 Microtask Queue。</p></blockquote><p>无论是 Task Queue 还是 Microtask Queue，其中的 task 和 microtask 的执行都是异步的。 为了对上述两个队列有更直观的认识，这里举个例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'setTimeout'</span>));</span><br><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Promise'</span>);</span><br><span class="line">    <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Promise queued by Promise'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'stack'</span>);</span><br></pre></td></tr></table></figure></p><p>上述代码片段中有两个Task（stack, setTimeout），两个 Microtask（Promise、Promise queued by Promise）。 stack 是当前任务会先执行；setTimeout 是第二个任务，在它执行前会清空 Microtask Queue。 这时 Microtask Queue 只有一个 Microtask（Promise）， 在它执行的过程中会插入第二个 Microtask（Promise queued by Promise）。 这些 Microtask 都会在下一个 Task（setTimeout）之前执行。因此输出为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stack</span><br><span class="line"><span class="built_in">Promise</span></span><br><span class="line"><span class="built_in">Promise</span> queued by <span class="built_in">Promise</span></span><br><span class="line">setTimeout</span><br></pre></td></tr></table></figure></p><ul><li>注意与 .then 的回调不同，new Promise 的回调是同步执行的。可参考 Promise 回调的执行 一文。</li><li>在 Jake 的 Tasks, microtasks, queues and schedules 一文中有更加详细的例子，感兴趣的读者可前往观摩。</li></ul><h2 id="何时会阻塞-UI"><a href="#何时会阻塞-UI" class="headerlink" title="何时会阻塞 UI"></a>何时会阻塞 UI</h2><p>UI 渲染和交互的处理是通过 Task Queue 来调度的，因此耗时任务会导致渲染和交互任务得不到调用，也就是页面“卡死”。 典型的浏览器会在每秒插入 60 个渲染帧，也就是说每 16ms 需要一次渲染。 如果存在一个任务在 16ms 内未能执行结束，页面就会掉帧给人卡顿的感觉。 渲染帧的详细讨论可以参考 <a href="https://harttle.land/2017/08/15/browser-render-frame.html" target="_blank" rel="noopener">浏览器的 16ms 渲染帧</a> 一文， 这里 Harttle 给一个<a href="http://harttle.github.io/async-and-render" target="_blank" rel="noopener">例子</a>。</p><p>在 <code>Loop for 10 seconds</code> 部分我们写了 4 种不同的循环，它们的表现如下：</p><table><thead><tr><th style="text-align:left">循环</th><th style="text-align:left">API    队列类型</th><th style="text-align:left">期间页面能否交互</th><th style="text-align:left">每秒执行次数</th></tr></thead><tbody><tr><td style="text-align:left">while(true)</td><td style="text-align:left">当前任务</td><td style="text-align:left">否</td><td style="text-align:left">701665.8</td></tr></tbody></table><p>| Promise    | Microtask Queue    | 否    | 609555.4|<br>| setTimeout|     Task Queue|     是    | 208.3|<br>| requestAnimationFrame    | vTask Queue    | 是|     59| </p><ul><li>页面不可交互是指：无法点击其他按钮、无法操作输入控件、无法选择/赋值页面文本。</li><li>以 PC Chrome 为例，iOS Safari 尤其是 UIWebview 的表现可能会不同。</li></ul><p>单个的耗时任务和 Microtask Queue 都会阻塞页面交互，Task 则不影响。 因为 Task 之间浏览器有机会会插入 UI 任务。 这里还可以观察到 setTimeout 虽然设置了 0 延时但调用次数远小于 while，甚至远小于 Microtask。 下文 setImmediate 章节会详细讨论原因。</p><h2 id="渲染任务的时机"><a href="#渲染任务的时机" class="headerlink" title="渲染任务的时机"></a>渲染任务的时机</h2><p>有时我们希望精确地控制浏览器在每一帧的绘制，这时就要了解浏览器绘制的时机。 首先举个例子，我们希望页面背景闪现一下红色：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.style.background = <span class="string">'red'</span>;</span><br><span class="line"><span class="built_in">document</span>.body.style.background = <span class="string">'white'</span>;</span><br></pre></td></tr></table></figure><p>上述代码一定达不到效果，背景会稳定地呈现白色。 因为 JavaScript “run-to-completion” 的特性，在上述两行代码之间不可能插入渲染任务。 这时可能有人想到 setTimeout：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.style.background = <span class="string">'red'</span>;</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.body.style.background = <span class="string">'white'</span>;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这样两次背景设置会在不同的任务中执行，如果这两个任务之间插入了渲染任务背景就会发生闪动。 但渲染任务是 16ms 一次，你怎么知道浏览器会正好插入在这两个任务之间？ 因此上述代码只会几率性起作用，背景闪动的几率大概 <code>4/16.67 = 25%</code>。 16.67 是渲染帧间隔，那为什么是 4ms 呢？请看下文 setImmediate。</p><p>想要增大几率到 100% 怎么办？setTimeout 100ms 呗… 其实 HTML5 中给出了 requestAnimationFrame API，使得脚本有机会精确地控制动画：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">requestAnimationFrame(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.body.style.background = <span class="string">'red'</span>;</span><br><span class="line">    requestAnimationFrame(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.body.style.background = <span class="string">'white'</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>插入的任务会在每次渲染任务之前执行，因此等待渲染之后需要调用两次来插入到第二次渲染之前。 这样背景一定会闪现红色。同样下面页面的 “Switch background red and white” 部分给了<a href="http://harttle.github.io/async-and-render" target="_blank" rel="noopener">例子</a></p><h2 id="setImmediate-是啥"><a href="#setImmediate-是啥" class="headerlink" title="setImmediate 是啥"></a>setImmediate 是啥</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/setImmediate" target="_blank" rel="noopener">setImmediate</a> 是由 IE 提出的， 目前尚未形成标准。当前状态是 Proposal 且只有 IE 有实现。 setImmediate 是为了让脚本更快地执行，与 setTimeout 一样都使用 Task Queue。 为了解 setImmediate 的用途，我们先看 setTimeout 为什么不够快。 下面的文本来自 HTML5 Living Standard 的 timer initialization steps:</p><blockquote><ol><li>If timeout is less than 0, then set timeout to 0.</li><li>If nesting level is greater than 5, and timeout is less than 4, then set timeout to 4.</li><li>Increment nesting level by one.</li></ol></blockquote><p>其中 nesting level 是指 <a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timer-nesting-level" target="_blank" rel="noopener">timer nesting level</a>， 每一级可能是 setTimeout 也可能是 setInterval。也就是说在嵌套 5 层以上时，会设置最小 4ms 的延迟。 setImmediate 意在让脚本有机会在 UA 事件和渲染发生后立即得到调用，从渲染的角度上类似于渲染之后调用的 requestAnimationFrame。 由于没有广泛实现，使用 setImmediate 需要引入 Polyfill。请参考：</p><p><a href="https://github.com/YuzuJS/setImmediate/blob/master/README.md" target="_blank" rel="noopener">https://github.com/YuzuJS/setImmediate/blob/master/README.md</a></p>]]></content>
    
    <summary type="html">
    
      JavaScript 是单线程的，但提供了很多异步调用方式比如 setTimeout，setInterval，setImmediate，Promise.prototype.then，postMessage，requestAnimationFrame， I/O，DOM 事件等。 这些异步调用的实现都是事件循环，但根据插入的队列不同和取任务的时机不同他们的表现也不同。 尤其在涉及与页面渲染的关系时。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="性能" scheme="https://daihaoxin.github.io/tags/%E6%80%A7%E8%83%BD/"/>
    
  </entry>
  
  <entry>
    <title>React Router迷之实现</title>
    <link href="https://daihaoxin.github.io/post/5603cf15.html"/>
    <id>https://daihaoxin.github.io/post/5603cf15.html</id>
    <published>2019-01-12T16:00:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要是通过创建一个基本版本的React Router v4 来理解背后实现的原理。如果要学习React Router怎么使用，请移步<a href="https://reacttraining.com/react-router/" target="_blank" rel="noopener">官方文档</a></p><h2 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h2><p><code>Route</code>是用来渲染 UI的，具体点就是<strong>当一个 URL 匹配上了你所指定的路由路径，就进行渲染</strong>。</p><p>Route 组件常用的属性主要有四个<code>exact</code>、<code>path</code>、<code>component</code>和<code>render</code>，这个四个属性的主要作用为：<br>exact: 只有当所给路径精确匹配上 location.pathname 时才返回 true。<br>path: 非必须属性，如果改属性不存在，那么路由对应的组件将自动渲染<br>component: 如果路径匹配上了，则渲染属性对应的组件<br>render： 允许你创建一个直接返回 UI 的内联函数而不用创建额外的组件</p><p><code>Route</code>的功能是渲染匹配指定路由路径的组件，所以<code>Router</code>需要做到的功能为：判断当前的<code>URL</code>是否和组件的<code>path</code>相匹配，如果匹配则返回渲染的<code>UI</code>；否则返回<code>null</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断path是否匹配</span></span><br><span class="line"><span class="keyword">const</span> matchPatch = <span class="function">(<span class="params">pathname, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; exact = <span class="literal">false</span>, path &#125; = options</span><br><span class="line">    <span class="keyword">if</span> (!path) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        path: <span class="literal">null</span>,</span><br><span class="line">        url: pathname,</span><br><span class="line">        isExact: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> match = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^<span class="subst">$&#123;path&#125;</span>`</span>).exec(pathname)</span><br><span class="line">    <span class="keyword">if</span>(!match)&#123;</span><br><span class="line">        <span class="comment">// 没有匹配上</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> url = match[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> isExact = url === patchname;</span><br><span class="line">    <span class="keyword">if</span>(exact &amp;&amp; !isExact)&#123;</span><br><span class="line">        <span class="comment">// 匹配上了 ， 但是不精确</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        path,url,isExact</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="title">extend</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        exact: PropTypes.bool,</span><br><span class="line">        path: PropTypes.string,</span><br><span class="line">        component: PropTypes.func,</span><br><span class="line">    r   ender: PropTypes.func,</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">let</span> &#123;path,render,component,exact&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">let</span> match = matchPath(location.pathname,&#123;path,exact&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!match)&#123;</span><br><span class="line">            <span class="comment">// path匹配失败， 返回null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// path 匹配成功</span></span><br><span class="line">        <span class="keyword">if</span>(component)&#123;</span><br><span class="line">            <span class="comment">// 如果component属性存在</span></span><br><span class="line">            <span class="comment">// 以 component 创建新元素并且传递 match </span></span><br><span class="line">            <span class="keyword">return</span> React.createElement(component,&#123;match,loaction&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(render)&#123;</span><br><span class="line">            <span class="comment">// 如果render存在</span></span><br><span class="line">            <span class="comment">// 则调用 render 并以 match 作为参数</span></span><br><span class="line">            <span class="keyword">return</span> render(&#123;match,loction&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码即实现了：<strong>如果匹配上了 path 属性，就返回 UI，否则什么也不做</strong>。</p><p>这里还有一种情况就是点击浏览器前进/后退按钮改变<code>URL</code>的时候，需要让<code>Route</code>可以做出针对性的处理。<br>当用户点击了后退/前进按钮的时候，<code>popstate</code>事件会被触发，因此只需要监听<code>popstate</code>事件，在<code>URL</code>被改变时，触发<code>popstate</code>去检查是否匹配上了新的 URL，如果是则渲染 UI，如果不是，什么也不做。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断path是否匹配</span></span><br><span class="line"><span class="keyword">const</span> matchPatch = <span class="function">(<span class="params">pathname, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; exact = <span class="literal">false</span>, path &#125; = options</span><br><span class="line">    <span class="keyword">if</span> (!path) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        path: <span class="literal">null</span>,</span><br><span class="line">        url: pathname,</span><br><span class="line">        isExact: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> match = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^<span class="subst">$&#123;path&#125;</span>`</span>).exec(pathname)</span><br><span class="line">    <span class="keyword">if</span>(!match)&#123;</span><br><span class="line">        <span class="comment">// 没有匹配上</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> url = match[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> isExact = url === patchname;</span><br><span class="line">    <span class="keyword">if</span>(exact &amp;&amp; !isExact)&#123;</span><br><span class="line">        <span class="comment">// 匹配上了 ， 但是不精确</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        path,url,isExact</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="title">extend</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        exact: PropTypes.bool,</span><br><span class="line">        path: PropTypes.string,</span><br><span class="line">        component: PropTypes.func,</span><br><span class="line">        render: PropTypes.func,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        <span class="comment">// 加了一个 popstate 监听，当 popstate 触发的时候，调用 forceUpdate 来强制做重新渲染的判断。</span></span><br><span class="line">        <span class="built_in">window</span>.addEventListener(<span class="string">"popstate"</span>,<span class="keyword">this</span>.handlePopstate);</span><br><span class="line">    &#125;</span><br><span class="line">    componentWillUnMount()&#123;</span><br><span class="line">        <span class="comment">// 组件卸载时，移除监听事件</span></span><br><span class="line">        <span class="built_in">window</span>.removeEventListener(<span class="string">"popstate"</span>,<span class="keyword">this</span>.handlePopstate);</span><br><span class="line">    &#125;</span><br><span class="line">    handlePopstate()&#123;</span><br><span class="line">        <span class="keyword">this</span>.forceUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">let</span> &#123;path,render,component,exact&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">let</span> match = matchPath(location.pathname,&#123;path,exact&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!match)&#123;</span><br><span class="line">            <span class="comment">// path匹配失败， 返回null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// path 匹配成功</span></span><br><span class="line">        <span class="keyword">if</span>(component)&#123;</span><br><span class="line">            <span class="comment">// 如果component属性存在</span></span><br><span class="line">            <span class="comment">// 以 component 创建新元素并且传递 match </span></span><br><span class="line">            <span class="keyword">return</span> React.createElement(component,&#123;match,loaction&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(render)&#123;</span><br><span class="line">            <span class="comment">// 如果render存在</span></span><br><span class="line">            <span class="comment">// 则调用 render 并以 match 作为参数</span></span><br><span class="line">            <span class="keyword">return</span> render(&#123;match,loction&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就实现了根据后退/前进按钮来“重匹配”、“重判断”和“重渲染”。</p><h2 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h2><p><code>Link</code>主要是解决通过<code>a</code>标签改变<code>URL</code>的时候，重新匹配<code>Route</code>组件并渲染的问题。<br><code>Link</code>一般是这样的使用的<code>&lt;Link to=&#39;/some-path&#39; replace={false} /&gt;</code>，<code>to</code>是一个<code>string</code>类型，表示要跳转到的链接。<code>replace</code>是布尔类型，如果为<code>true</code>，则将替换<code>history</code>中的最后一个链接替换为当前的链接，否则就添加当前链接到<code>history</code>中。</p><p>首先，<code>Link</code>需要渲染一个<code>a</code>标签，并且需要组织<code>a</code>的默认动作，以免全页面刷新，所以需要一个<code>click</code>事件处理函数来阻止<code>a</code>的默认动作。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Link</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        to: PropTypes.string.isRequired,</span><br><span class="line">        replace: PropTypes.bool</span><br><span class="line">    &#125;</span><br><span class="line">    onClick(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">let</span> &#123;to,replace&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;a href=&#123;<span class="keyword">this</span>.props.to&#125; onClick=&#123;<span class="keyword">this</span>.handleClick&#125;&gt;&#123;<span class="keyword">this</span>.props.children&#125;&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>然后需要处理更新<code>URL</code>的部分，通过<code>history</code>的<code>api</code>更新路由，我们需要在点击事件中，获取目标<code>URL</code>，然后通知目标<code>URL</code>对应的<code>Route</code>组件渲染。</p><p>为了可以准确的渲染路由对应的组件，我们需要将所有的路由收集起来，没当地址发生改变的时候，就遍历数组，并调用<code>forceUpdate</code>函数。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里创建的两个函数，用来收集Route和删除Route</span></span><br><span class="line"><span class="keyword">let</span> instances = [];</span><br><span class="line"><span class="keyword">const</span> register = <span class="function">(<span class="params">comp</span>)=&gt;</span>&#123;instances.push(comp);&#125;;</span><br><span class="line"><span class="keyword">const</span> unregister = <span class="function">(<span class="params">comp</span>)=&gt;</span>&#123;instances.splice(instances.indexOf(comp),<span class="number">1</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新 Route 组件</span></span><br><span class="line"><span class="comment">// 判断path是否匹配</span></span><br><span class="line"><span class="keyword">const</span> matchPatch = <span class="function">(<span class="params">pathname, options</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="title">extend</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        <span class="comment">// 加了一个 popstate 监听，当 popstate 触发的时候，调用 forceUpdate 来强制做重新渲染的判断。</span></span><br><span class="line">        <span class="built_in">window</span>.addEventListener(<span class="string">"popstate"</span>,<span class="keyword">this</span>.handlePopstate);</span><br><span class="line">        register(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    componentWillUnMount()&#123;</span><br><span class="line">        <span class="comment">// 组件卸载时，移除监听事件</span></span><br><span class="line">        <span class="built_in">window</span>.removeEventListener(<span class="string">"popstate"</span>,<span class="keyword">this</span>.handlePopstate);</span><br><span class="line">        unregister(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    handlePopstate()&#123;</span><br><span class="line">        <span class="keyword">this</span>.forceUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新 Link 组件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Link</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        to: PropTypes.string.isRequired,</span><br><span class="line">        replace: PropTypes.bool</span><br><span class="line">    &#125;</span><br><span class="line">    onClick(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">let</span> &#123;to,replace&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">if</span>(replace)&#123;</span><br><span class="line">            history.replaceState(&#123;&#125;,<span class="literal">null</span>,to)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            history.pushState(&#123;&#125;,<span class="literal">null</span>,to)</span><br><span class="line">        &#125;</span><br><span class="line">        instances.forEach(<span class="function"><span class="params">item</span>=&gt;</span>item.forceUpdate());</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;a href=&#123;<span class="keyword">this</span>.props.to&#125; onClick=&#123;<span class="keyword">this</span>.handleClick&#125;&gt;&#123;<span class="keyword">this</span>.props.children&#125;&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p><h2 id="Redirect"><a href="#Redirect" class="headerlink" title="Redirect"></a>Redirect</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redirect</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> defaultProps=&#123;</span><br><span class="line">        push:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        push: PropTypes.bool.isRequired,</span><br><span class="line">        to: PropTypes.string.isRequired</span><br><span class="line">    &#125;</span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        <span class="keyword">let</span> &#123;to,push&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">if</span>(push)&#123;</span><br><span class="line">            history.pushState(&#123;&#125;,<span class="literal">null</span>,to);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            history.replaceState(&#123;&#125;,<span class="literal">null</span>,to);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/4e86372cb2fb" target="_blank" rel="noopener">https://www.jianshu.com/p/4e86372cb2fb</a></p>]]></content>
    
    <summary type="html">
    
      认识React大概是在三年前，做开源日志处理系统`graylog`的汉化时，而真正使用React开发项目只有一年半的时间，这个过程中最让我迷茫的莫过于客户端路由这部分，今天终于有时间来分析下React Router背后实现机制，算是个总结吧
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="react" scheme="https://daihaoxin.github.io/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>js实现全排列组合算法</title>
    <link href="https://daihaoxin.github.io/post/24a5b0c6.html"/>
    <id>https://daihaoxin.github.io/post/24a5b0c6.html</id>
    <published>2019-01-09T04:00:00.000Z</published>
    <updated>2019-03-17T06:19:04.447Z</updated>
    
    <content type="html"><![CDATA[<p>全排列组合算法，例如a,b,c,d进行全排列组合，则组合结果为：a,b,ab,c,ac,bc,abc,d,ad,bd,abd,cd,acd,bcd,abcd。实现思路：从数据源拿出一个元素，依次与已存在的组合数据进行组合，循环上面操作直到数据源没有数据为止。</p><p>例子：数据源a,b,c</p><p>1.拿出a，组合数据group为空，插入数据源a元素到组合数据group，此时group=[a]</p><p>2.拿出b，组合数据group拿出a，a和b组合，得到ab，把数据源b元素、ab插入组合数据group，此时group=[a,b,ab]</p><p>3.拿出c，组合数据group拿出a、b、ab，分别与c组合，分别得到ac、bc、abc，把数据源c元素、ac、bc、abc插入组合数据group，此时<code>group=[a,b,ab,c,ac,bc,abc]</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getGroup</span>(<span class="params">data, index = <span class="number">0</span>, group = []</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> need_apply = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    need_apply.push(data[index]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; group.length; i++) &#123;</span><br><span class="line">        need_apply.push(group[i] + data[index]);</span><br><span class="line">    &#125;</span><br><span class="line">    group.push.apply(group, need_apply);</span><br><span class="line">    <span class="keyword">if</span>(index + <span class="number">1</span> &gt;= data.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> group;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getGroup(data, index + <span class="number">1</span>, group);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">console</span>.log(getGroup(data));</span><br></pre></td></tr></table></figure><p>运行输出结果：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="string">'a'</span>,</span><br><span class="line">  <span class="string">'b'</span>,</span><br><span class="line">  <span class="string">'ab'</span>,</span><br><span class="line">  <span class="string">'c'</span>,</span><br><span class="line">  <span class="string">'ac'</span>,</span><br><span class="line">  <span class="string">'bc'</span>,</span><br><span class="line">  <span class="string">'abc'</span>,</span><br><span class="line">  <span class="string">'d'</span>,</span><br><span class="line">  <span class="string">'ad'</span>,</span><br><span class="line">  <span class="string">'bd'</span>,</span><br><span class="line">  <span class="string">'abd'</span>,</span><br><span class="line">  <span class="string">'cd'</span>,</span><br><span class="line">  <span class="string">'acd'</span>,</span><br><span class="line">  <span class="string">'bcd'</span>,</span><br><span class="line">  <span class="string">'abcd'</span> ]</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      通过JavaScript实现全排列组合。
    
    </summary>
    
      <category term="javascript" scheme="https://daihaoxin.github.io/categories/javascript/"/>
    
    
      <category term="算法" scheme="https://daihaoxin.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
</feed>
